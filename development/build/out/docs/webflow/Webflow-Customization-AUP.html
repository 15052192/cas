<hr>
<h2>
<a id="layout-defaulttitle-cas---web-flow-acceptable-usage-policycategory-webflow-management" class="anchor" href="#layout-defaulttitle-cas---web-flow-acceptable-usage-policycategory-webflow-management" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Web Flow Acceptable Usage Policy<br>
category: Webflow Management</h2>
<h1>
<a id="acceptable-usage-policy" class="anchor" href="#acceptable-usage-policy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Acceptable Usage Policy</h1>
<p>Also known as <em>Terms of Use</em> or <em>EULA</em>, CAS presents the ability to allow the user to accept the usage policy before moving on to the application.<br>
Production-level deployments of this feature would require modifications to the flow such that the retrieval<br>
and/or acceptance of the policy would be handled via an external storage mechanism such as LDAP or JDBC.</p>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-webflow" %}</p>
<p>Customize the policy by modifying the <code>src/main/resources/templates/casAcceptableUsagePolicyView.html</code>. See <a href="../ux/User-Interface-Customization.html">this guide</a><br>
to learn more about user interface customizations. Note that the view here should have full access to the resolved principal and attributes,<br>
if you wish to dynamically alter the page to present different text, etc.</p>
<!-- raw HTML omitted -->
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h2>
<a id="per-service" class="anchor" href="#per-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Per Service</h2>
<p>Acceptable usage policy can be disabled and skipped on a per-service basis:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.services.RegexRegisteredService",
  "serviceId": "https://app.example.org",
  "name": "Example",
  "id": 1,
  "acceptableUsagePolicy":
  {
    "@class": "org.apereo.cas.services.DefaultRegisteredServiceAcceptableUsagePolicy",
    "enabled": true,
    "messageCode": "example.code",
    "text": "example text"
  }
}
</code></pre>
<p>The policy assigned to each service includes the following features:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enabled</code></td>
<td>Control whether policy is active/inactive for this service. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>messageCode</code></td>
<td>The policy language code that is linked to the CAS language bundles which carries the actual policy text.</td>
</tr>
<tr>
<td><code>text</code></td>
<td>The policy text that should be displayed for this application.</td>
</tr>
</tbody>
</table>
<h2>
<a id="storage-mechanism" class="anchor" href="#storage-mechanism" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Storage Mechanism</h2>
<p>Usage policy user decisions are stored and remembered via the following ways.</p>
<p>In almost all storage strategies, CAS allows the deployer<br>
to detect the current user's policy choice via a CAS single-valued <code>boolean</code> attribute.<br>
The attribute must be resolved using the <a href="../integration/Attribute-Resolution.html">CAS attribute resolution strategy</a>.<br>
If the attribute contains a value of <code>false</code>, CAS will attempt to<br>
ask for policy acceptance. Upon accepting the policy, the result will be stored back into storage.</p>
<h3>
<a id="default" class="anchor" href="#default" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default</h3>
<p>By default the task of remembering the user's choice is kept in memory by default and will be lost upon<br>
container restarts and/or in clustered deployments. This option is only useful during development, testing<br>
and demos and is not at all suitable for production.</p>
<p>The scope of the default storage mechanism can be adjusted from the default of GLOBAL (described above) to<br>
AUTHENTICATION which will result in the user having to agree to the policy during each authentication event.<br>
The user will not have to agree to the policy when CAS grants access based on an existing ticket granting<br>
ticket cookie.</p>
<h3>
<a id="groovy" class="anchor" href="#groovy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy</h3>
<p>Alternatively, CAS can be configured to use a Groovy script to verify status<br>
of policies and store results. The script should match the following:</p>
<pre lang="groovy"><code>import org.apereo.cas.authentication.principal.*
import org.apereo.cas.authentication.*
import org.apereo.cas.util.*
import org.apereo.cas.aup.*
import org.springframework.webflow.execution.*

def verify(Object[] args) {
    def requestContext = args[0]
    def credential = args[1]
    def applicationContext = args[2]
    def principal = args[3]
    def logger = args[4]
    ...
    if (policyAccepted()) {
        return AcceptableUsagePolicyStatus.accepted(principal)
    }
    return AcceptableUsagePolicyStatus.denied(principal)
}

def submit(Object[] args) {
     def requestContext = args[0]
     def credential = args[1]
     def applicationContext = args[2]
     def principal = args[3]
     def logger = args[4]
     ...
     return true
}
     
/*
    A special callback function is implemented
    as an override to return an `AcceptableUsagePolicyTerms` 
    object back to CAS to be re-purposed
    for acceptable usage policy flows.
*/
def fetch(Object[] args) {
    def requestContext = args[0]
    def credential = args[1]
    def applicationContext = args[2]
    def principal = args[3]
    def logger = args[4]

    ...    

    return AcceptableUsagePolicyTerms.builder()
            .defaultText("Hello, World")
            .code(AcceptableUsagePolicyTerms.CODE)
            .build();
}
</code></pre>
<p>The parameters passed are as follows:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>requestContext</code></td>
<td>The object representing the Spring Webflow <code>RequestContext</code>.</td>
</tr>
<tr>
<td><code>credential</code></td>
<td>The object representing the authentication <code>Credential</code>.</td>
</tr>
<tr>
<td><code>applicationContext</code></td>
<td>The object representing the Spring <code>ApplicationContext</code>.</td>
</tr>
<tr>
<td><code>principal</code></td>
<td>The object representing the authenticated <code>Principal</code>.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<h3>
<a id="ldap" class="anchor" href="#ldap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LDAP</h3>
<p>Alternatively, CAS can be configured to use LDAP as the storage mechanism. Upon accepting the policy, the result will be stored back into LDAP and<br>
remembered via the same attribute. Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-ldap" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#ldap-1">review this guide</a>.</p>
<h3>
<a id="mongodb" class="anchor" href="#mongodb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MongoDb</h3>
<p>CAS can be configured to use a MongoDb instance as the storage mechanism. Upon accepting the policy, the adopter is expected to provide a collection name where the<br>
decision is kept and the document is assumed to contain a <code>username</code> column as well as one that matches the AUP attribute name defined.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-mongo" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="redis" class="anchor" href="#redis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Redis</h3>
<p>CAS can be configured to use a Redis instance as the storage mechanism. Decisions are mapped to a combination of CAS username and the designated AUP attribute name.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-redis" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="couchdb" class="anchor" href="#couchdb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CouchDb</h3>
<p>CAS can be configured to use a CouchDb instance as the storage mechanism. Upon accepting the policy, the adopter is expected to provide a collection name where the<br>
decision is kept and the document is assumed to contain a <code>username</code> column as well as one that matches the AUP attribute name defined.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-couchdb" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="couchbase" class="anchor" href="#couchbase" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Couchbase</h3>
<p>CAS can be configured to use a Couchbase instance as the storage mechanism. Upon accepting the policy, the<br>
decision is kept inside a document with a <code>username</code> column and the AUP attribute name with the result of the decision.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-couchbase" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="jdbc" class="anchor" href="#jdbc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JDBC</h3>
<p>CAS can be configured to use a database as the storage mechanism. Upon accepting the policy, the adopter is expected to provide a table name where the<br>
decision is kept and the table is assumed to contain a <code>username</code> column as well as one that matches the AUP attribute name defined.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-jdbc" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h3>
<p>CAS can be configured to use a REST API as the storage mechanism. Upon accepting the policy,<br>
the API is contacted passing along a <code>username</code> parameter who has accepted the policy. The expected response status code is <code>200</code>.</p>
<p>Furthermore, the API endpoint at <code>${endpoint}/policy</code> will be invoked by CAS to fetch the appropriate policy terms.<br>
The API is contacted passing along <code>username</code> and <code>locale</code> parameters and the expected response status code is <code>200</code>. The response<br>
output body is expected to be an instance of <code>AcceptableUsagePolicyTerms</code> as such:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.aup.AcceptableUsagePolicyTerms",
  "code": "screen.aup.policyterms.some.key",
  "defaultText": "Default policy text"
}
</code></pre>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-aup-rest" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>
<h3>
<a id="custom" class="anchor" href="#custom" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom</h3>
<p>If you wish to design your own storage mechanism, you may follow the below approach:</p>
<pre lang="java"><code>package org.apereo.cas.custom;

@Configuration("myUsagePolicyConfiguration")
@EnableConfigurationProperties(CasConfigurationProperties.class)
public class MyUsagePolicyConfiguration {

    @Bean
    public AcceptableUsagePolicyRepository acceptableUsagePolicyRepository() {
      ...
    }

}
</code></pre>
<p><a href="../configuration/Configuration-Management-Extensions.html">See this guide</a> to learn more about how to register configurations into the CAS runtime.</p>
<h2>
<a id="policy-terms" class="anchor" href="#policy-terms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Policy Terms</h2>
<p>Storage options outlined above are also available to fetch the acceptable usage policy<br>
and pass it along to the appropriate views for display and acceptance under the attribute <code>aupPolicy</code>.<br>
The policy terms can reference to a particular message code found in CAS language bundles,<br>
or it can contain the default policy text that would be used for display verbatim.</p>
<p>Unless the storage option overrides and specializes this ability, th default behavior to fetch policy terms<br>
is based on a single-valued attribute defined in CAS properties that typically might indicate user status or membership.<br>
The attribute value is appended to the language code <code>screen.aup.policyterms</code> to then allow CAS to look up the specific<br>
policy text from language bundles. If no such key is available in CAS languages bundles, a default policy text<br>
found under the same language key will be displayed.</p>
<p>The defined attribute must of course be available for the resolved authenticated principal from the relevant sources.</p>
<p>For example, if the policy terms attribute is defined as <code>status</code> with the value of <code>developer</code>, the expected language<br>
code to carry the policy text would be <code>screen.aup.policyterms.developer=&lt;p&gt;Policy for developers&lt;/p&gt;</code>.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#acceptable-usage-policy">review this guide</a>.</p>