<hr>
<h2>
<a id="layout-defaulttitle-cas---trusted-device-multifactor-authenticationcategory-multifactor-authentication" class="anchor" href="#layout-defaulttitle-cas---trusted-device-multifactor-authenticationcategory-multifactor-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Trusted Device Multifactor Authentication<br>
category: Multifactor Authentication</h2>
<h1>
<a id="multifactor-authentication-trusted-devicebrowser" class="anchor" href="#multifactor-authentication-trusted-devicebrowser" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multifactor Authentication Trusted Device/Browser</h1>
<p>In addition to triggers that are provided by the <a href="Configuring-Multifactor-Authentication.html">MFA functionality</a> of CAS, there may be<br>
cases where you wish to let the user decide if the current browser/device should be trusted so as to skip subsequent MFA requests. The<br>
objective is for CAS to remember that decision for a configurable period of time and not bother the user with MFA until the decision<br>
is either forcefully revoked or considered expired.</p>
<p>Trusting a device during an MFA workflow would mean that the ultimate decision is remembered for that <strong>user</strong> of that <strong>location</strong><br>
of that <strong>device</strong>. These keys are combined together securely and assigned to the final decision.</p>
<p>Before deployment, you should consider the following:</p>
<ul>
<li>Should users be optionally allowed to authorize the "current" device?</li>
<li>...or must that happen automatically once MFA is commenced?</li>
<li>How should user decisions and choices be remembered? Where are they stored?</li>
<li>How long should user decisions be trusted by CAS?</li>
<li>How is a trusted authentication session communicated back to an application?</li>
</ul>
<p>Note that enabling this feature by default means it's globally applied to all in the case if you have multiple MFA providers turned on.<br>
This can be optionally disabled and applied only to a selected set of providers.</p>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2>
<a id="administrative-endpoints" class="anchor" href="#administrative-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Administrative Endpoints</h2>
<p>The following endpoints are provided by CAS:</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>multifactorTrustedDevices</code></td>
<td>Expose devices currently <a href="Multifactor-TrustedDevice-Authentication.html">registered and trusted</a> by the CAS multifactor authentication engine. A <code>GET</code> operation produces a list of all trusted devices. Specifying a username in the URL as the placeholder/selector will fetch devices registered for that user (i.e. <code>multifactorTrustedDevices/{username}</code>). A <code>DELETE</code> operation with a device key  id will attempt to remove the trusted device (i.e. <code>multifactorTrustedDevices/{id}</code>).</td>
</tr>
</tbody>
</table>
<h2>
<a id="settings" class="anchor" href="#settings" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Settings</h2>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#multifactor-trusted-devicebrowser">review this guide</a>.</p>
<h2>
<a id="authentication-context" class="anchor" href="#authentication-context" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authentication Context</h2>
<p>If an MFA request is bypassed due to a trusted authentication decision, applications will receive a special attribute as part of<br>
the validation payload that indicates this behavior. Applications must further account for the scenario where they ask for an MFA<br>
mode and yet don't receive confirmation of it in the response given the authentication session was trusted and MFA bypassed.</p>
<h2>
<a id="device-fingerprint" class="anchor" href="#device-fingerprint" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Device Fingerprint</h2>
<p>In order to distinguish trusted devices from each other we need to calculate a device fingerprint that uniquely<br>
identifies individual devices. Calculation of this device fingerprint can utilize a combination of multiple components<br>
from the request.</p>
<p>Device fingerprint can be calculated using the following ways:</p>
<ul>
<li>Client IP address</li>
<li>Randomly generated cookie plus the client IP (default)</li>
<li>
<a href="../installation/GeoTracking-Authentication-Requests.html">GeoLocation address</a>. You do need to ensure CAS is<br>
allowed to <a href="../installation/Configuring-Authentication-Events.html">ask and process geodata</a> provided by the browser.</li>
<li>User-agent header</li>
</ul>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#trusted-device-fingerprint">review this guide</a>.</p>
<h2>
<a id="bypass" class="anchor" href="#bypass" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bypass</h2>
<p>Users are allowed to optionally opt out of registering a trusted device with CAS as part of the MFA workflow. Furthermore,<br>
trusted device workflow for MFA can be bypassed on a per application basis:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.services.RegexRegisteredService",
  "serviceId": "^(https|imaps)://app.example.org",
  "name": "Example",
  "id": 1,
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "bypassTrustedDeviceEnabled" : true
  }
}
</code></pre>
<h2>
<a id="storage" class="anchor" href="#storage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Storage</h2>
<p>User decisions must be remembered and processed later on subsequent requests.  A background <em>cleaner</em> process is also automatically scheduled to<br>
scan the chosen repository/database/registry periodically and remove expired records based on configured threshold parameters.</p>
<!-- raw HTML omitted -->
<h3>
<a id="default" class="anchor" href="#default" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default</h3>
<p>If you do nothing, by default records are kept inside the runtime memory and cached for a configurable amount of time.<br>
This is most useful if you have a very small deployment with a small user base or if you wish to demo the functionality.</p>
<h3>
<a id="json" class="anchor" href="#json" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JSON</h3>
<p>Records may be kept inside a static json resource whose path is defined via CAS settings.<br>
This is also most useful if you have a very small deployment with a small user base or if you wish to demo the functionality.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#json-storage">review this guide</a>.</p>
<h3>
<a id="jdbc" class="anchor" href="#jdbc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JDBC</h3>
<p>User decisions may also be kept inside a regular RDBMS of your own choosing.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-jdbc&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To learn how to configure database drivers, <a href="../installation/JDBC-Drivers.html">please see this guide</a>.<br>
To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#jdbc-storage">review this guide</a>.</p>
<h3>
<a id="couchdb" class="anchor" href="#couchdb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CouchDb</h3>
<p>User decisions may also be kept inside a CouchDb instance.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-couchdb&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#couchdb-storage">review this guide</a>.</p>
<h3>
<a id="mongodb" class="anchor" href="#mongodb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MongoDb</h3>
<p>User decisions may also be kept inside a MongoDb instance.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-mongo&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#mongodb-storage">review this guide</a>.</p>
<h3>
<a id="dynamodb" class="anchor" href="#dynamodb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DynamoDb</h3>
<p>User decisions may also be kept inside a DynamoDb instance.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-dynamodb&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#dynamodb-storage">review this guide</a>.</p>
<h3>
<a id="redis" class="anchor" href="#redis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Redis</h3>
<p>User decisions may also be kept inside a Redis instance.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-redis&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#redis-storage">review this guide</a>.</p>
<h3>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h3>
<p>If you wish to completely delegate the management, verification and persistence of user decisions, you may design a REST API<br>
which CAS shall contact to verify user decisions and remember those for later.</p>
<p>Support is provided via the following module:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-trusted-mfa-rest&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#rest-storage">review this guide</a>.</p>
<h4>
<a id="retrieve-trusted-records" class="anchor" href="#retrieve-trusted-records" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Retrieve Trusted Records</h4>
<p>A <code>GET</code> request that returns all trusted authentication records that are valid and not-expired.</p>
<pre lang="bash"><code>curl -i -H "Accept: application/json" -H "Content-Type: application/json" -X GET "${endpointUrl}/[principal|date]"
</code></pre>
<p>Response payload may produce a collection of objects that contain:</p>
<pre lang="json"><code>[
    {
      "principal": "casuser",
      "deviceFingerprint": "...",
      "recordDate": "YYYY-MM-dd",  
      "expirationDate":  "YYYY-MM-dd", 
      "name": "Office",
      "recordKey": "..."
    }
]
</code></pre>
<h4>
<a id="store-trusted-records" class="anchor" href="#store-trusted-records" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Store Trusted Records</h4>
<p>A <code>POST</code> request that stores a newly trusted device record.</p>
<pre lang="bash"><code>curl -H "Content-Type: application/json" -X POST -d '${json}' ${endpointUrl}
</code></pre>
<p><code>POST</code> data will match the following block:</p>
<pre lang="json"><code>{
    "principal": "...",
    "deviceFingerprint": "...",
    "recordDate": "...",    
    "expirationDate":  "YYYY-MM-dd", 
    "name": "...",
    "recordKey": "..."
}
</code></pre>
<p>Response payload shall produce a <code>200</code> http status code to indicate a successful operation.</p>