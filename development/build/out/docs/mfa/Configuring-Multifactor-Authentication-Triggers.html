<hr>
<h2>
<a id="layout-defaulttitle-cas---multifactor-authentication-triggerscategory-multifactor-authentication" class="anchor" href="#layout-defaulttitle-cas---multifactor-authentication-triggerscategory-multifactor-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Multifactor Authentication Triggers<br>
category: Multifactor Authentication</h2>
<h1>
<a id="multifactor-authentication-triggers" class="anchor" href="#multifactor-authentication-triggers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multifactor Authentication Triggers</h1>
<p>The following triggers can be used to activate and instruct CAS to navigate to a multifactor authentication flow.<br>
To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#multifactor-authentication">review this guide</a>.</p>
<p>The execution order of multifactor authentication triggers is outlined below:</p>
<ol>
<li>Adaptive</li>
<li>Global</li>
<li>Opt-In Request Parameter/Header</li>
<li>REST Endpoint</li>
<li>Groovy Script</li>
<li>Principal Attribute Per Application</li>
<li>Global Principal Attribute Predicate</li>
<li>Global Principal Attribute</li>
<li>Global Authentication Attribute</li>
<li>Applications</li>
<li>Grouper</li>
<li>Entity ID Request Parameter</li>
<li>Other</li>
</ol>
<p>Each trigger should properly try to ignore the authentication request, if applicable configuration is not found for its activation and execution. Also note that various CAS modules present and inject their own <em>internal triggers</em> into the CAS application runtime in order to translate protocol-specific authentication requests (such as those presented by SAML2 or OpenID Connect) into multifactor authentication flows.</p>
<!-- raw HTML omitted -->
<p>The trigger machinery in general should be completely oblivious to multifactor authentication; all it cares about is finding the next event in the chain in a very generic way. This means that it is technically possible to combine multiple triggers each of which may produce a different event in the authentication flow. In the event, having selected a final candidate event, the appropriate component and module that is able to support and respond to the produced event will take over and route the authentication flow appropriately.</p>
<h2>
<a id="global" class="anchor" href="#global" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Global</h2>
<p>MFA can be triggered for all applications and users regardless of individual settings.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#multifactor-authentication">review this guide</a>.</p>
<h2>
<a id="per-application" class="anchor" href="#per-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Per Application</h2>
<p>MFA can be triggered for a specific application registered inside the CAS service registry.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps)://.*",
  "id" : 100,
  "name": "test",
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "multifactorAuthenticationProviders" : [ "java.util.LinkedHashSet", [ "mfa-duo" ] ],
    "bypassEnabled": false,
    "forceExecution": true
  }
}
</code></pre>
<p>The following fields are accepted by the policy definition</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>multifactorAuthenticationProviders</code></td>
<td>Set of multifactor provider ids that should trigger for this application.</td>
</tr>
<tr>
<td><code>script</code></td>
<td>Path to a script, whether external or internal, to trigger multifactor authentication dynamically.</td>
</tr>
<tr>
<td><code>bypassEnabled</code></td>
<td>Whether multifactor authentication should be <a href="Configuring-Multifactor-Authentication-Bypass.html">bypassed</a> for this service.</td>
</tr>
<tr>
<td><code>forceExecution</code></td>
<td>Whether multifactor authentication should forcefully trigger, even if the existing authentication context can be satisfied without MFA.</td>
</tr>
</tbody>
</table>
<h3>
<a id="groovy-per-application" class="anchor" href="#groovy-per-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy Per Application</h3>
<p>You may determine the multifactor authentication policy for a registered service using a Groovy script:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps)://.*",
  "id" : 100,
  "name": "test",
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "script" : "file:///etc/cas/config/mfa-policy.groovy"
  }
}
</code></pre>
<p>The script may also be embedded directly in the service definition, as such:</p>
<p>you may determine the multifactor authentication policy for a registered service using a Groovy script:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps)://.*",
  "id" : 100,
  "name": "test",
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "script" : "groovy { ... }"
  }
}
</code></pre>
<p>The script itself may be designed as follows:</p>
<pre lang="groovy"><code>def run(final Object... args) {
    def authentication = args[0]
    def registeredService = args[1]
    def httpRequest = args[2]
    def service = args[3]
    def applicationContext = args[4]
    def logger = args[5]

    logger.debug("Determine mfa provider for ${registeredService} and ${authentication}")
    return "mfa-duo"
}
</code></pre>
<p>The parameters passed are as follows:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>registeredService</code></td>
<td>The object representing the corresponding service definition in the registry.</td>
</tr>
<tr>
<td><code>authentication</code></td>
<td>The object representing the <code>Authentication</code> object.</td>
</tr>
<tr>
<td><code>httpRequest</code></td>
<td>The object representing the HTTP servlet request.</td>
</tr>
<tr>
<td><code>service</code></td>
<td>The object representing the service request, associated with this http request.</td>
</tr>
<tr>
<td><code>applicationContext</code></td>
<td>The object representing the Spring application context.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<p>The expected outcome of the script is either <code>null</code> in case multifactor authentication should be skipped by this trigger,<br>
or the identifier of the multifactor provider that should be considered for activation.</p>
<h3>
<a id="groovy-per-application-deprecated" class="anchor" href="#groovy-per-application-deprecated" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy Per Application (Deprecated)</h3>
<!-- raw HTML omitted -->
<p>Additionally, you may determine the multifactor authentication policy for a registered service using a Groovy script:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps)://.*",
  "id" : 100,
  "name": "test",
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.GroovyRegisteredServiceMultifactorPolicy",
    "groovyScript" : "file:///etc/cas/config/mfa-policy.groovy"
  }
}
</code></pre>
<p>The script itself may be designed as such by overriding the needed operations where necessary:</p>
<pre lang="groovy"><code>import org.apereo.cas.services.*
import java.util.*

class GroovyMultifactorPolicy extends DefaultRegisteredServiceMultifactorPolicy {
    @Override
    Set&lt;String&gt; getMultifactorAuthenticationProviders() {
        ...
    }

    @Override
    RegisteredServiceMultifactorPolicyFailureModes getFailureMode() {
        ...
    }

    @Override
    String getPrincipalAttributeNameTrigger() {
        ...
    }

    @Override
    String getPrincipalAttributeValueToMatch() {
        ...
    }

    @Override
    boolean isBypassEnabled() {
        ...
    }

    @Override
    boolean isForceExecution() {
        ...
    }
}
</code></pre>
<p>The configuration of this component qualifies to use the <a href="../configuration/Configuration-Spring-Expressions.html">Spring Expression Language</a> syntax. Refer to the CAS API documentation to learn more about operations and expected behaviors.</p>
<h2>
<a id="global-principal-attribute" class="anchor" href="#global-principal-attribute" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Global Principal Attribute</h2>
<p>MFA can be triggered for all users/subjects carrying a specific attribute that matches one of the conditions below.</p>
<ul>
<li>
<p>Trigger MFA based on a principal attribute(s) whose value(s) matches a regex pattern.<br>
<strong>Note</strong> that this behavior is only applicable if there is only a <strong>single MFA provider</strong> configured, since that would allow CAS<br>
to know what provider to next activate.</p>
</li>
<li>
<p>Trigger MFA based on a principal attribute(s) whose value(s) <strong>EXACTLY</strong> matches an MFA provider.<br>
This option is more relevant if you have more than one provider configured or if you have the flexibility of assigning provider ids to attributes as values.</p>
</li>
</ul>
<p>Needless to say, the attributes need to have been resolved for the principal prior to this step. To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#multifactor-authentication">review this guide</a>.</p>
<h2>
<a id="global-principal-attribute-predicate" class="anchor" href="#global-principal-attribute-predicate" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Global Principal Attribute Predicate</h2>
<p>This is a more generic variant of the above trigger. It may be useful in cases where there is more than one provider configured and available in the application runtime and you need to design a strategy to dynamically decide on the provider that should be activated for the request.</p>
<p>The decision is handed off to a <code>Predicate</code> implementation defined in a Groovy script whose location is taught to CAS. The responsibility of the <code>test</code> function in the script is to determine eligibility of the provider to be triggered. If the predicate determines multiple providers as eligible by returning <code>true</code> more than one, the first provider in the sorted result set ranked by the provider's order will be chosen to respond.</p>
<p>The Groovy script predicate may be designed as such:</p>
<pre lang="groovy"><code>import org.apereo.cas.authentication.*
import java.util.function.*
import org.apereo.cas.services.*

class PredicateExample implements Predicate&lt;MultifactorAuthenticationProvider&gt; {

    def service
    def principal
    def providers
    def logger

    public PredicateExample(service, principal, providers, logger) {
        this.service = service
        this.principal = principal
        this.providers = providers
        this.logger = logger
    }

    @Override
    boolean test(final MultifactorAuthenticationProvider p) {
        ...
    }
}
</code></pre>
<p>The parameters passed are as follows:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>service</code></td>
<td>The object representing the corresponding service definition in the registry.</td>
</tr>
<tr>
<td><code>principal</code></td>
<td>The object representing the authenticated principal.</td>
</tr>
<tr>
<td><code>providers</code></td>
<td>Collection of <code>MultifactorAuthenticationProvider</code>s from which a selection shall be made.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#multifactor-authentication">review this guide</a>.</p>
<p>As an example, the following predicate example will begin to test each multifactor authentication provider and if the given provider is <code>mfa-duo</code> it will accept it as a valid trigger so long as the provider can be reached.</p>
<pre lang="groovy"><code>import org.apereo.cas.authentication.*
import java.util.function.*
import org.apereo.cas.services.*

class PredicateExample implements Predicate&lt;MultifactorAuthenticationProvider&gt; {

    def service
    def principal
    def providers
    def logger

    public PredicateExample(service, principal, providers, logger) {
        this.service = service
        this.principal = principal
        this.providers = providers
        this.logger = logger
    }

    @Override
    boolean test(final MultifactorAuthenticationProvider p) {
        logger.info("Testing provider {}", p.getId())
        if (p.matches("mfa-duo")) {
           logger.info("Provider {} is available. Checking eligibility...", p.getId())
           if (p.isAvailable(this.service)) {
               logger.info("Provider {} matched. Good to go!", p.getId())
               return true;
           }
           logger.info("Skipping provider {}. Match failed.", p.getId())
           return false; 
        }
        logger.info("Provider {} cannot be reached", p.getId())
        return false
    }
}
</code></pre>
<h2>
<a id="global-authentication-attribute" class="anchor" href="#global-authentication-attribute" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Global Authentication Attribute</h2>
<p>MFA can be triggered for all users/subjects whose <em>authentication event/metadata</em> has resolved a specific attribute<br>
that matches one of the below conditions:</p>
<ul>
<li>
<p>Trigger MFA based on a <em>authentication attribute(s)</em> whose value(s) matches a regex pattern.<br>
<strong>Note</strong> that this behavior is only applicable if there is only a <strong>single MFA provider</strong> configured, since that would allow CAS<br>
to know what provider to next activate.</p>
</li>
<li>
<p>Trigger MFA based on a <em>authentication attribute(s)</em> whose value(s) <strong>EXACTLY</strong> matches an MFA provider.<br>
This option is more relevant if you have more than one provider configured or if you have the flexibility of assigning<br>
provider ids to attributes as values.</p>
</li>
</ul>
<p>Needless to say, the attributes need to have been resolved for the authentication event prior to this step. This trigger<br>
is generally useful when the underlying authentication engine signals CAS to perform additional validation of credentials.<br>
This signal may be captured by CAS as an attribute that is part of the authentication event metadata which can then trigger<br>
additional multifactor authentication events.</p>
<p>An example of this scenario would be the "Access Challenge response" produced by RADIUS servers.</p>
<h2>
<a id="adaptive" class="anchor" href="#adaptive" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adaptive</h2>
<p>MFA can be triggered based on the specific nature of a request that may be considered outlawed. For instance,<br>
you may want all requests that are submitted from a specific IP pattern, or from a particular geographical location<br>
to be forced to go through MFA. CAS is able to adapt itself to various properties of the incoming request<br>
and will route the flow to execute MFA. See <a href="Configuring-Adaptive-Authentication.html">this guide</a> for more info.</p>
<h2>
<a id="grouper" class="anchor" href="#grouper" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Grouper</h2>
<p>MFA can be triggered by <a href="https://incommon.org/software/grouper/">Grouper</a><br>
groups to which the authenticated principal is assigned.<br>
Groups are collected by CAS and then cross-checked against all available/configured MFA providers.<br>
The group's comparing factor <strong>MUST</strong> be defined in CAS to activate this behavior<br>
and it can be based on the group's name, display name, etc where<br>
a successful match against a provider id shall activate the chosen MFA provider.</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-grouper" %}</p>
<p>You will also need to ensure <code>grouper.client.properties</code> is available on the classpath<br>
with the following configured properties:</p>
<pre lang="properties"><code>grouperClient.webService.url = http://192.168.99.100:32768/grouper-ws/servicesRest
grouperClient.webService.login = banderson
grouperClient.webService.password = password
</code></pre>
<h2>
<a id="groovy" class="anchor" href="#groovy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy</h2>
<p>MFA can be triggered based on the results of a groovy script of your own design. The outcome of the script should determine the MFA provider id that CAS should attempt to activate.</p>
<p>The outline of the groovy script is shown below as a sample:</p>
<pre lang="groovy"><code>import java.util.*

class SampleGroovyEventResolver {
    def String run(final Object... args) {
        def service = args[0]
        def registeredService = args[1]
        def authentication = args[2]
        def httpRequest = args[3]
        def logger = args[4]

        ...

        return "mfa-duo"
    }
}
</code></pre>
<p>The parameters passed are as follows:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>service</code></td>
<td>The object representing the incoming service provided in the request, if any.</td>
</tr>
<tr>
<td><code>registeredService</code></td>
<td>The object representing the corresponding service definition in the registry.</td>
</tr>
<tr>
<td><code>authentication</code></td>
<td>The object representing the established authentication event, containing the principal.</td>
</tr>
<tr>
<td><code>httpRequest</code></td>
<td>The object representing the <code>HttpServletRequest</code>.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<p>As an example, the following script triggers multifactor authentication via Duo Security, if the requesting application is <code>https://www.example.com</code> and the authenticated principal contains a <code>mail</code> attribute whose values contain <code>email@example.org</code>.</p>
<pre lang="groovy"><code>import java.util.*

class MyExampleScript {
    def String run(final Object... args) {
        def service = args[0]
        def registeredService = args[1]
        def authentication = args[2]
        def httpRequest = args[3]
        def logger = args[4]

        if (service.id == "https://www.example.com") {
            logger.info("Evaluating principal attributes [{}]", authentication.principal.attributes)

            def mail = authentication.principal.attributes['mail']
            if (mail.contains("email@example.org")) {
                logger.info("Found mail attribute with value [{}]", mail)
                return "mfa-duo"
            }
        }
        return null
    }
}
</code></pre>
<h2>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h2>
<p>MFA can be triggered based on the results of a remote REST endpoint of your design. If the endpoint is configured,<br>
CAS shall issue a <code>POST</code>, providing the authenticated username as <code>principalId</code> and <code>serviceId</code> as the service<br>
url in the body of the request.</p>
<p>Endpoints must be designed to accept/process <code>application/json</code>. The body of the response in<br>
the event of a successful <code>200</code> status code is expected to be the MFA provider id which CAS should activate.</p>
<h2>
<a id="opt-in-request-parameterheader" class="anchor" href="#opt-in-request-parameterheader" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Opt-In Request Parameter/Header</h2>
<p>MFA can be triggered for a specific authentication request, provided<br>
the initial request to the CAS <code>/login</code> endpoint contains a parameter/header<br>
that indicates the required MFA authentication flow. The parameter/header name<br>
is configurable, but its value must match the authentication provider id<br>
of an available MFA provider described above.</p>
<p>An example request that triggers an authentication flow based on a request parameter would be:</p>
<pre lang="bash"><code>https://.../cas/login?service=...&amp;&lt;PARAMETER_NAME&gt;=&lt;MFA_PROVIDER_ID&gt;
</code></pre>
<p>The same strategy also applied to triggers that are based on request/session attributes, which tend to get used for internal communications between APIs and CAS components specially when designing extensions.</p>
<h2>
<a id="principal-attribute-per-application" class="anchor" href="#principal-attribute-per-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Principal Attribute Per Application</h2>
<p>As a hybrid option, MFA can be triggered for a specific application registered inside the CAS service registry, provided<br>
the authenticated principal carries an attribute that matches a configured attribute value. The attribute<br>
value can be an arbitrary regex pattern. See below to learn about how to configure MFA settings.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps)://.*",
  "id" : 100,
  "name": "test",
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "multifactorAuthenticationProviders" : [ "java.util.LinkedHashSet", [ "mfa-duo" ] ],
    "principalAttributeNameTrigger" : "memberOf",
    "principalAttributeValueToMatch" : "faculty|allMfaMembers"
  }
}
</code></pre>
<h2>
<a id="entity-id-request-parameter" class="anchor" href="#entity-id-request-parameter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Entity Id Request Parameter</h2>
<p>In situations where authentication is delegated to CAS, most commonly<br>
via a <a href="https://www.shibboleth.net/products/">Shibboleth Identity Provider</a>,  the entity id may be passed as<br>
a request parameter to CAS to be treated as a CAS registered service.<br>
This allows one to activate multifactor authentication policies based on the entity id that is registered<br>
This allows one to [activate multifactor authentication policies](#Per Application) based on the entity id that is registered<br>
in the CAS service registry. As a side benefit, the entity id can take advantage of all other CAS features<br>
such as access strategies and authorization rules simply because it's just another service definition known to CAS.</p>
<p>To learn more about integration options and to understand how to delegate authentication to CAS<br>
from a Shibboleth identity provider, please <a href="../integration/Shibboleth.html">see this guide</a>.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-shibboleth" %}</p>
<p>The <code>entityId</code> parameter may be passed as such:</p>
<pre lang="bash"><code>https://.../cas/login?service=http://idp.example.org&amp;entityId=the-entity-id-passed
</code></pre>
<h2>
<a id="custom" class="anchor" href="#custom" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom</h2>
<p>While support for triggers may seem extensive, there is always that edge use case that would have you trigger MFA based on a special set of requirements. To learn how to design your own triggers, <a href="Configuring-Multifactor-Authentication-CustomTriggers.html">please see this guide</a>.</p>