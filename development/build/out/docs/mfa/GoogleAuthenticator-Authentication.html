<hr>
<h2>
<a id="layout-defaulttitle-cas---google-authenticator-authenticationcategory-multifactor-authentication" class="anchor" href="#layout-defaulttitle-cas---google-authenticator-authenticationcategory-multifactor-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Google Authenticator Authentication<br>
category: Multifactor Authentication</h2>
<h1>
<a id="google-authenticator-authentication" class="anchor" href="#google-authenticator-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Google Authenticator Authentication</h1>
<p>Google Authenticator generates 2-step verification codes on your phone. With 2-step verification signing in will require a code generated by the Google Authenticator app in addition to primary authentication. Learn more about the topic <a href="https://en.wikipedia.org/wiki/Google_Authenticator">here</a>.</p>
<p>Note that the functionality presented here should also be compatible with the likes of <a href="https://lastpass.com/auth">LastPass Authenticator</a>, etc.</p>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>Support is enabled by including the following module in the overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator">review this guide</a>.</p>
<h2>
<a id="administrative-endpoints" class="anchor" href="#administrative-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Administrative Endpoints</h2>
<p>The following endpoints are provided by CAS:</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gauthCredentialRepository</code></td>
<td>Manage and control <a href="GoogleAuthenticator-Authentication.html">Google Authenticator account records</a>. A <code>GET</code> operation produces a list of all account records. A <code>DELETE</code> operation will delete all account records. A <code>GET</code> operation produces with a parameter selector of <code>/{username}</code> will list the record assigned to the user. A <code>DELETE</code> operation produces with a parameter selector of <code>/{username}</code> will remove the record assigned to the user.</td>
</tr>
</tbody>
</table>
<h2>
<a id="token-repository" class="anchor" href="#token-repository" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Token Repository</h2>
<p>In order to prevent reuse of tokens issued, CAS will attempt to keep track of tokens that are successfully used to authenticate the user.<br>
The repository that holds registration records and tokens is periodically scanned and cleaned up so that expired and previously used tokens<br>
may be removed.</p>
<h2>
<a id="registration" class="anchor" href="#registration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Registration</h2>
<p>By default, an account registry implementation is included that collects user device registrations and saves them into memory.<br>
Issued tokens are also captured into a self-cleaning cache to prevent token reuse for a configurable period of time.<br>
This option should only be used for demo and testing purposes. Production deployments of this feature will require a separate<br>
implementation of the registry that is capable to register accounts into persistent storage.</p>
<p>Note that each individual account is allowed to register multiple devices to be used later for multifactor authentication. Duration the<br>
authentication flow, the user will be asked to select the appropriate device for authentication if multiple device registration records<br>
are found. The ability to handle multiple device registration records can be controlled via CAS settings.</p>
<h3>
<a id="jpa" class="anchor" href="#jpa" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JPA</h3>
<p>Registration records and tokens may be kept inside a database instance via the following module:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth-jpa" %}</p>
<p>To learn how to configure database drivers, <a href="../installation/JDBC-Drivers.html">please see this guide</a>.<br>
To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-jpa">review this guide</a>.</p>
<h3>
<a id="couchdb" class="anchor" href="#couchdb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CouchDb</h3>
<p>Registration records and tokens may be kept inside a CouchDb instance, via the following module:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth-couchdb" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-couchdb">review this guide</a>.</p>
<h3>
<a id="mongodb" class="anchor" href="#mongodb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MongoDb</h3>
<p>Registration records and tokens may be kept inside a MongoDb instance, via the following module:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth-mongo" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-mongodb">review this guide</a>.</p>
<h3>
<a id="redis" class="anchor" href="#redis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Redis</h3>
<p>Registration records and tokens may be kept inside a Redis instance via the following module:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth-redis" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-redis">review this guide</a>.</p>
<h3>
<a id="ldap" class="anchor" href="#ldap" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LDAP</h3>
<p>Registration records may be kept inside LDAP/AD systems via the following module:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-gauth-ldap" %}</p>
<p>Account registration records are kept inside a designated configurable multi-valued attribute as JSON blobs. The attribute values are parsed<br>
to load, save, update or delete accounts. The content of each attribute value can be signed/encrypted if necessary.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-ldap">review this guide</a>.</p>
<h3>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h3>
<p>Registration records may also be passed along to a REST endpoint.<br>
The behavior is only activated when an endpoint url is provided.</p>
<p>| Method    | Headers             | Expected Response     | Behavior<br>
|-----------|------------------------------------------------------------------------------------<br>
| <code>GET</code>     | <code>username</code>          | <code>200</code>. Account records in the body for the user. | Fetch user records<br>
| <code>GET</code>     | <code>id</code>                | <code>200</code>. Account record in the body for the user. | Fetch record for the given identifier.<br>
| <code>GET</code>     | <code>id</code>, <code>username</code>    | <code>200</code>. Account record in the body for the user. | Fetch user record for the given identifier.<br>
| <code>GET</code>     | N/A                 | <code>200</code>. Account records currently registered. | Fetch all records<br>
| <code>DELETE</code>  | N/A                 | <code>200</code>. | Delete all records.<br>
| <code>DELETE</code>  | <code>username</code>          | <code>200</code>. Count deleted records. | Delete all records assigned to user<br>
| <code>POST</code>    | <code>username</code>, <code>validationCode</code>, <code>secretKey</code>, <code>scratchCodes</code>, <code>name</code> | <code>200</code>. <code>true/false</code> in the body. | Save user record</p>
<p>A sample payload that lists device registration records for the user might be:</p>
<pre lang="json"><code>[
    "java.util.ArrayList", [{
        "@class": "org.apereo.cas.gauth.credential.GoogleAuthenticatorAccount",
        "scratchCodes": ["java.util.ArrayList", [14883628,81852839,40126334,86724930,54355266] ],
        "id": 123456,
        "secretKey": "UM6ALPJU34CBNFTBBLRFMKBNANMFAIBW",
        "validationCode": 565889,
        "username": "casuser",
        "name": "required-account-name",
        "registrationDate": "2018-06-20T09:47:31.761155Z"
    }]
]
</code></pre>
<p>The following endpoints need also be available:</p>
<p>| Method    | Endpoint   | Headers           | Expected Response     | Behavior<br>
|-----------|------------------------------------------------------------------------------------<br>
| <code>GET</code>     | <code>count</code>    | N/A             | <code>200</code>. Numeric count | Count all records<br>
| <code>GET</code>     | <code>count</code>    | <code>username</code>             | <code>200</code>. Numeric count | Count all records for the user</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-rest">review this guide</a>.</p>
<h3>
<a id="json" class="anchor" href="#json" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JSON</h3>
<p>Registration records may also be kept inside a single JSON file for all users.<br>
The behavior is only activated when a path to a JSON data store file is provided,<br>
and otherwise CAS may fallback to keeping records in memory. This feature is mostly<br>
useful during development and for demo purposes.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#google-authenticator-json">review this guide</a>.</p>
<h2>
<a id="rest-protocol-credential-extraction" class="anchor" href="#rest-protocol-credential-extraction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST Protocol Credential Extraction</h2>
<p>In the event that the <a href="../protocol/REST-Protocol.html">CAS REST Protocol</a> is turned on, a special credential extractor is injected into the REST authentication engine in order to recognize credentials and authenticate them as part of the REST request.<br>
The expected parameter name in the request body is <code>gauthotp</code>. The account identifier may also be passed using the <code>gauthacct</code> parameter in the request body.</p>