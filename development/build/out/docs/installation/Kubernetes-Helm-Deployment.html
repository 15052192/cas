<hr>
<h2>
<a id="layout-defaulttitle-cas---kubernetes-helm-deploymentcategory-installation" class="anchor" href="#layout-defaulttitle-cas---kubernetes-helm-deploymentcategory-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Kubernetes Helm Deployment<br>
category: Installation</h2>
<p>{% include variables.html %}</p>
<h1>
<a id="kubernetes-helm-installation" class="anchor" href="#kubernetes-helm-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Kubernetes Helm Installation</h1>
<p>The <a href="WAR-Overlay-Initializr.html">CAS WAR Overlay Initializr</a> includes a CAS Helm chart that can<br>
be used to deploy CAS on a Kubernetes cluster. This document won't discuss setting up a production<br>
Kubernetes cluster, but it will walk through setting CAS up using a <a href="https://helm.sh/">Helm</a> chart<br>
on a local Kubernetes cluster. This document assumes the <a href="WAR-Overlay-Initializr.html">CAS Initializr</a><br>
has been used to create an overlay since that Initializr project houses the Helm chart and<br>
the overlay generated by the initializr is needed for building the CAS container image.</p>
<!-- raw HTML omitted -->
<h1>
<a id="what-is-helm" class="anchor" href="#what-is-helm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What is Helm?</h1>
<p>Helm Charts are a set of templates that are combined with deployment specific values<br>
to generate Kubernetes configuration yaml. The deployer of a Helm chart should be able to<br>
make their own values file that overrides any default values that the chart defines and install<br>
the application without having to change the templates. If the templates need changing,<br>
those changes are candidates for contributing back the Helm chart, so it will get more customizable<br>
and support more deployment options over time.</p>
<h1>
<a id="cas-helm-chart-overview" class="anchor" href="#cas-helm-chart-overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CAS Helm Chart Overview</h1>
<p>The current helm chart for CAS will deploy CAS with a Spring Boot Admin Server.<br>
Eventually it might be nice to support a config-server and have cas-management or cas-shell available.<br>
The chart supports mapping in arbitrary volumes and cas config can be specified in values files.<br>
The config could be in cloud config rather than kubernetes config maps, the service registry<br>
could be in a database, git, or a simple json registry in a kubernetes persistent volume.<br>
The ticket registry could use a standard helm chart for redis, postgresql, or mongo, etc.<br>
Currently, the chart is using SSL between ingress controller and the CAS and Boot Admin servers.<br>
This may be overkill and involves all the pain that comes with SSL (e.g. trust &amp; hostname verification).<br>
This chart uses <code>StatefulSet</code> for CAS rather than a <code>Deployment</code> but this may change in the future or<br>
become configurable.</p>
<p>The Boot Admin CAS server discovery method should probably change to "cloud" discovery eventually.</p>
<h2>
<a id="installing-cas-on-local-kubernetes-installation" class="anchor" href="#installing-cas-on-local-kubernetes-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installing CAS on local Kubernetes Installation</h2>
<p>The following sections provide an overview of the steps for installing Helm and Kubernetes and<br>
getting the CAS Helm chart installed and running locally.</p>
<h3>
<a id="install-helm-and-kubectl" class="anchor" href="#install-helm-and-kubectl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install Helm and Kubectl</h3>
<p>Helm v3 and Kubectl are just single binary programs. Kubectl may come with the kubernetes<br>
installation, but both should be downloaded and put them in the PATH.</p>
<ul>
<li>Install <a href="https://helm.sh/docs/intro/install/">Helm</a>
</li>
<li>Install <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubectl</a>
</li>
</ul>
<h3>
<a id="install-kubernetes" class="anchor" href="#install-kubernetes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install Kubernetes</h3>
<p>There are multiple options for running a Kubernetes cluster on Mac, Windows or Linux, but<br>
they all require Linux as a VM or as the host OS. The CAS Helm Chart is installed and tested<br>
on a K3S Kubernetes installation as part of the continuous integration scripts of the CAS Initializr<br>
so that method should always work, but it does require users of Windows and Mac to install<br>
a Linux virtual machine (e.g. running Ubuntu);</p>
<ul>
<li>
<a href="https://k3s.io/">k3s</a> - Works on linux, very light-weight and easy to install for development.<br>
Installing Docker is not required.</li>
</ul>
<pre lang="shell"><code>  # install k3s, without traefik ingress controller
  curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --disable traefik" sh
  # the following export is needed for helm, put in profile
  export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
  # build a CAS image from the overlay generated from Initializr
  ./gradlew clean build jibBuildTar --refresh-dependencies
  # import the image to k3s (k3s can pull images from registries but can't see local docker images)
  k3s ctr images import build/jib-image.tar
  # verify the image is loaded
  k3s ctr images ls | grep cas
  # Go to folder with helm chart
  cd helm 
  # create secret for tomcat
  ./create-cas-server-keystore-secret.sh
  # create secret for ingress controller to use with CAS ingress (nginx-ingress will use default if not created)
  ./create-ingress-tls.sh
  # create configmap containing SSL trust store
  ./create-truststore.sh
  # install cas-server helm chart
  helm upgrade --install cas-server ./cas-server
</code></pre>
<h3>
<a id="other-options" class="anchor" href="#other-options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Other Options</h3>
<ul>
<li>
<p><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></p>
<ul>
<li>Install Docker Desktop</li>
<li>Enable Kubernetes in Settings</li>
<li>
<a href="#install-helm-and-kubectl">Helm and Kubectl</a> should be installed and added to path of bash terminal<br>
(Use Git Bash or Cygwin or Msys2 on Windows)</li>
<li>Run shell scripts for installing certs and trust stores (in <code>helm</code> sub-directory)</li>
<li>Build CAS image via <code>./gradlew clean build jibBuildTar --refresh-dependencies</code>
</li>
<li>Load CAS image locally into Docker <code>docker load &lt; build/jib-image.tar</code>
</li>
<li>Install <a href="#install-ingress-controller">Ingress Controller</a>
</li>
<li>Install CAS Helm chart</li>
</ul>
</li>
<li>
<p><a href="https://minikube.sigs.k8s.io/docs/start/">Minikube</a></p>
</li>
</ul>
<h3>
<a id="install-ingress-controller" class="anchor" href="#install-ingress-controller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install Ingress Controller</h3>
<p>The CAS Helm chart is only tested with Kubernetes ingress-nginx, feel free to add support for other ingress controllers.</p>
<p><a href="https://kubernetes.github.io/ingress-nginx/deploy/">Kubernetes Nginx Ingress Installation Guide</a></p>
<p>To install the ingress controller using Helm and the ingress-nginx Helm chart:</p>
<pre lang="shell"><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
kubectl create namespace ingress-nginx
helm install --namespace ingress-nginx ingress-nginx ingress-nginx/ingress-nginx
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=120s
</code></pre>
<h3>
<a id="install-cas-server-helm-chart" class="anchor" href="#install-cas-server-helm-chart" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install CAS Server Helm Chart</h3>
<p>Helm charts consist of templates which are combined with values from one or more values files<br>
(and command line set arguments) to produce kubernetes yaml. The chart folder (containing the <code>templates</code> directory)<br>
contains a default values.yaml that is used by default but additional values files should be<br>
specified on the command line to override the default values as appropriate.<br>
The following examples use the <code>default</code> namespace but <code>--namespace cas</code> can be added to any<br>
of the following <code>helm</code> commands to put CAS in its own kubernetes namespace (The namespace would<br>
need to be created first, e.g. <code>kubectl create namespace cas</code>)</p>
<pre lang="bash"><code># delete cas-server helm chart install
helm delete cas-server
# install cas-server chart 
helm install cas-server ./cas-server
# install or update cas-server
helm upgrade --install cas-server ./cas-server
# use local values file to override defaults 
helm upgrade --install cas-server --values values-local.yaml ./cas-server
# see kubernetes yaml without installing  
helm upgrade --install cas-server --values values-local.yaml ./cas-server --dry-run --debug
# sometimes dry-run fails b/c yaml can't convert to json so use template instead to see problem
helm template cas-server --values values-local.yaml ./cas-server --debug
</code></pre>
<h3>
<a id="useful-kubectl-commands" class="anchor" href="#useful-kubectl-commands" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Useful <code>kubectl</code> Commands</h3>
<p>Don't forget to add <code>-n</code> or <code>--namespace</code> if using non-default namespace.</p>
<pre lang="bash"><code># Look at the pods to see the status
kubectl get pods 
# Describe the CAS pod to see why it isn't starting
kubectl describe pod cas-server-0
# tail the console logs
kubectl logs cas-server-0 -f
# exec into container
kubectl exec -it cas-server-0 sh
# bounce CAS pod
kubectl delete pod cas-server-0
</code></pre>
<h3>
<a id="browse-to-cas" class="anchor" href="#browse-to-cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Browse to CAS</h3>
<p>Make sure host file entries exist for whatever host is listed in values file for this entry:</p>
<pre lang="yaml"><code>ingress:
  hosts:
    - host: cas.example.org
      paths: 
        - "/cas"
  tls: 
    - secretName: cas-server-ingress-tls
      hosts:
        - cas.example.org
</code></pre>
<pre lang="bash"><code># host entry
127.0.0.1 cas.example.org 
</code></pre>
<p>If the CAS pod is running, browse to <code>https://cas.example.org/cas/login</code>.<br>
There is also an ingress for the CAS Spring Boot Admin server that should be accessible<br>
using the host name specified for the Boot Admin's ingress.<br>
The CAS Spring Boot Admin server has its own ingress since it is meant to be internally accessible<br>
and CAS is likely external, but both could be internal or external.</p>