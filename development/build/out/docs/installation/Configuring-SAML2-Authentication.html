<hr>
<h2>
<a id="layout-defaulttitle-cas---saml2-authenticationcategory-protocols" class="anchor" href="#layout-defaulttitle-cas---saml2-authenticationcategory-protocols" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - SAML2 Authentication<br>
category: Protocols</h2>
<h1>
<a id="saml2-authentication" class="anchor" href="#saml2-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML2 Authentication</h1>
<p>CAS can act as a SAML2 identity provider accepting authentication requests and producing SAML assertions.</p>
<p>If you intend to allow CAS to delegate authentication to an external SAML2 identity provider, you need to <a href="../integration/Delegate-Authentication.html">review this guide</a>.</p>
<!-- raw HTML omitted -->
<h2>
<a id="federation-interop-evaluation" class="anchor" href="#federation-interop-evaluation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Federation Interop Evaluation</h2>
<p>The CAS project strives to conform to the <a href="https://kantarainitiative.github.io/SAMLprofiles/fedinterop.html">SAML V2.0 Implementation Profile for Federation Interoperability</a>. An evaluation of the requirements against the current CAS release is available <a href="https://docs.google.com/spreadsheets/d/1NYN5n6AaNxz0UxwkzIDuXMYL1JUKNZZlSzLZEDUw4Aw/edit?usp=sharing">here</a>. It is recommended that you view, evaluate and comment on functionality that is currently either absent or marked questionable where verification is needed.</p>
<h2>
<a id="saml-endpoints" class="anchor" href="#saml-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML Endpoints</h2>
<p>The following CAS endpoints respond to supported SAML2 profiles:</p>
<ul>
<li><code>/idp/profile/SAML2/Redirect/SSO</code></li>
<li><code>/idp/profile/SAML2/POST/SSO</code></li>
<li><code>/idp/profile/SAML2/POST-SimpleSign/SSO</code></li>
<li><code>/idp/profile/SAML2/POST/SLO</code></li>
<li><code>/idp/profile/SAML2/Redirect/SLO</code></li>
<li><code>/idp/profile/SAML2/Unsolicited/SSO</code></li>
<li><code>/idp/profile/SAML2/SOAP/ECP</code></li>
<li><code>/idp/profile/SAML2/SOAP/AttributeQuery</code></li>
<li><code>/idp/profile/SAML1/SOAP/ArtifactResolution</code></li>
</ul>
<h2>
<a id="idp-metadata" class="anchor" href="#idp-metadata" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>IdP Metadata</h2>
<p>The following CAS endpoints handle the generation of SAML2 metadata:</p>
<ul>
<li><code>/idp/metadata</code></li>
</ul>
<p>This endpoint will display the CAS IdP SAML2 metadata upon receiving a GET request. If metadata is already available and generated,<br>
it will be displayed. If metadata is absent, one will be generated automatically.<br>
CAS configuration below dictates where metadata files/keys will be generated and stored.</p>
<p>Note that the endpoint can accept a <code>service</code> parameter either by entity id or numeric identifier. This parameter<br>
is matched against the CAS service registry allowing the endpoint to calculate and combine any identity provider<br>
metadata overrides that may have been specified.</p>
<p>Here is a generated metadata file as an example:</p>
<pre lang="xml"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;EntityDescriptor xmlns="urn:oasis:names:tc:SAML:2.0:metadata" xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
                xmlns:shibmd="urn:mace:shibboleth:metadata:1.0" xmlns:xml="http://www.w3.org/XML/1998/namespace"
                xmlns:mdui="urn:oasis:names:tc:SAML:metadata:ui" entityID="ENTITY_ID"&gt;
    &lt;IDPSSODescriptor protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
        &lt;Extensions&gt;
            &lt;shibmd:Scope regexp="false"&gt;SCOPE&lt;/shibmd:Scope&gt;
        &lt;/Extensions&gt;
        &lt;KeyDescriptor use="signing"&gt;
            &lt;ds:KeyInfo&gt;
              &lt;ds:X509Data&gt;
                  &lt;ds:X509Certificate&gt;...&lt;/ds:X509Certificate&gt;
              &lt;/ds:X509Data&gt;
            &lt;/ds:KeyInfo&gt;
        &lt;/KeyDescriptor&gt;
        &lt;KeyDescriptor use="encryption"&gt;
            &lt;ds:KeyInfo&gt;
              &lt;ds:X509Data&gt;
                  &lt;ds:X509Certificate&gt;...&lt;/ds:X509Certificate&gt;
              &lt;/ds:X509Data&gt;
            &lt;/ds:KeyInfo&gt;
        &lt;/KeyDescriptor&gt;

        &lt;NameIDFormat&gt;urn:mace:shibboleth:1.0:nameIdentifier&lt;/NameIDFormat&gt;
        &lt;NameIDFormat&gt;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&lt;/NameIDFormat&gt;

        &lt;SingleLogoutService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
                             Location="https://HOST_NAME/cas/idp/profile/SAML2/POST/SLO"/&gt;
        &lt;SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
                             Location="https://HOST_NAME/cas/idp/profile/SAML2/POST/SSO"/&gt;
        &lt;SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
                             Location="https://HOST_NAME/cas/idp/profile/SAML2/Redirect/SSO"/&gt;
    &lt;/IDPSSODescriptor&gt;
&lt;/EntityDescriptor&gt;
</code></pre>
<p>SAML2 identity provider metadata can be managed in dynamics ways as well. To learn more, please <a href="Configuring-SAML2-DynamicMetadata.html">review this guide</a>.</p>
<h3>
<a id="per-service" class="anchor" href="#per-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Per Service</h3>
<p>Identity provider metadata, certificates and keys can also be defined on a per-service basis to override the global defaults.<br>
Metadata artifacts that would be applicable to a specific service definition and managed via the file system need to be stored<br>
in a directory location named after the service definition's name and numeric identifier inside the canonical metadata directory. For example,<br>
if global metadata artifacts are managed on disk at <code>/etc/cas/config/saml/metadata</code>, then metadata applicable to a service definition<br>
whose name is configured as <code>SampleService</code> with an id of <code>1000</code> are expected to be found at <code>/etc/cas/config/saml/metadata/SampleService-1000</code>.</p>
<p>SAML2 identity provider metadata can be managed in dynamics ways as well. To learn more, please <a href="Configuring-SAML2-DynamicMetadata.html">review this guide</a>.</p>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-saml-idp" %}</p>
<p>You may also need to declare the following repository in<br>
your CAS overlay to be able to resolve dependencies:</p>
<pre lang="groovy"><code>repositories {
    maven { 
        mavenContent { releasesOnly() }
        url "https://build.shibboleth.net/nexus/content/repositories/releases" 
    }
}
</code></pre>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#saml-idp">review this guide</a>.</p>
<h3>
<a id="administrative-endpoints" class="anchor" href="#administrative-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Administrative Endpoints</h3>
<p>The following endpoints are provided by CAS:</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>samlPostProfileResponse</code></td>
<td>Obtain a SAML2 response payload by supplying a <code>username</code>, <code>password</code> and <code>entityId</code> as parameters.</td>
</tr>
</tbody>
</table>
<h3>
<a id="saml-services" class="anchor" href="#saml-services" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML Services</h3>
<p>SAML relying parties and services must be registered within the CAS service registry similar to the following example:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId" : "the-entity-id-of-the-sp",
  "name" : "SAMLService",
  "id" : 10000003,
  "evaluationOrder" : 10,
  "metadataLocation" : "https://url/to/metadata.xml"
}
</code></pre>
<p>The following fields are available for SAML services:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>metadataLocation</code></td>
<td>Location of service metadata defined from system files, classpath, directories or URL resources.</td>
</tr>
<tr>
<td><code>metadataProxyLocation</code></td>
<td>Proxy endpoint (<code>https://proxy-address:8901</code>) to fetch service metadata from URL resources.</td>
</tr>
<tr>
<td><code>metadataSignatureLocation</code></td>
<td>Location of the metadata signing certificate/public key to validate the metadata which must be defined from system files or classpath. If defined, will enforce the <code>SignatureValidationFilter</code> validation filter on metadata.</td>
</tr>
<tr>
<td><code>metadataExpirationDuration</code></td>
<td>If defined, will expire metadata in the cache after the indicated duration which will force CAS to retrieve and resolve the metadata again.</td>
</tr>
<tr>
<td><code>requireSignedRoot</code></td>
<td>Whether incoming metadata's root element is required to be signed. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>signUnsolicitedAuthnRequest</code></td>
<td>When dealing with Unsolicited SSO, determine whether the authentication request should be forcefully signed.</td>
</tr>
<tr>
<td><code>signAssertions</code></td>
<td>Whether assertions should be signed. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>signResponses</code></td>
<td>Whether responses should be signed. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>encryptionOptional</code></td>
<td>Encrypt whenever possible (i.e a compatible key is found in the peer's metadata) or skip encryption otherwise. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>encryptAssertions</code></td>
<td>Whether assertions should be encrypted. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>encryptAttributes</code></td>
<td>Whether assertion attributes should be encrypted. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>encryptableAttributes</code></td>
<td>Set of attributes nominated for encryption, disqualifying others absent in this collection. Default (i.e. <code>*</code>) is to encrypt all once <code>encryptAttributes</code> is true.</td>
</tr>
<tr>
<td><code>requiredAuthenticationContextClass</code></td>
<td>If defined, will specify the SAML authentication context class in the final response. If undefined, the authentication class will either be <code>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</code> or <code>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</code> depending on the SAML authentication request.</td>
</tr>
<tr>
<td><code>requiredNameIdFormat</code></td>
<td>If defined, will force the indicated Name ID format in the final SAML response.</td>
</tr>
<tr>
<td><code>skewAllowance</code></td>
<td>If defined, indicates number of seconds used to skew authentication dates such as valid-from and valid-until elements, etc.</td>
</tr>
<tr>
<td><code>metadataCriteriaPattern</code></td>
<td>If defined, will force an entity id filter on the metadata aggregate based on the <code>PredicateFilter</code> to include/exclude specific entity ids based on a valid regex pattern.</td>
</tr>
<tr>
<td><code>metadataCriteriaDirection</code></td>
<td>If defined, will force an entity id filter on the metadata aggregate based on <code>PredicateFilter</code>. Allowed values are <code>INCLUDE</code>,<code>EXCLUDE</code>.</td>
</tr>
<tr>
<td><code>metadataCriteriaRoles</code></td>
<td>If defined, will allow the defined metadata roles (i.e. <code>SPSSODescriptor</code>, <code>IDPSSODescriptor</code>). Default is <code>SPSSODescriptor</code>.</td>
</tr>
<tr>
<td><code>metadataCriteriaRemoveEmptyEntitiesDescriptors</code></td>
<td>Controls whether to keep entities descriptors that contain no entity descriptors. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>metadataCriteriaRemoveRolelessEntityDescriptors</code></td>
<td>Controls whether to keep entity descriptors that contain no roles. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>attributeNameFormats</code></td>
<td>Map that defines attribute name formats for a given attribute name to be encoded in the SAML response.</td>
</tr>
<tr>
<td><code>attributeFriendlyNames</code></td>
<td>Map that defines attribute friendly names for a given attribute name to be encoded in the SAML response.</td>
</tr>
<tr>
<td><code>attributeValueTypes</code></td>
<td>Map that defines the type of attribute values for a given attribute name.</td>
</tr>
<tr>
<td><code>nameIdQualifier</code></td>
<td>If defined, will overwrite the <code>NameQualifier</code> attribute of the produced subject's name id.</td>
</tr>
<tr>
<td><code>logoutResponseBinding</code></td>
<td>If defined, will overwrite the binding used to prepare logout responses for the service provider.</td>
</tr>
<tr>
<td><code>issuerEntityId</code></td>
<td>If defined, will override the issue value with the given identity provider entity id. This may be useful in cases where CAS needs to maintain multiple identity provider entity ids.</td>
</tr>
<tr>
<td><code>assertionAudiences</code></td>
<td>Comma-separated list of audience urls to include in the assertion, in the addition to the entity id.</td>
</tr>
<tr>
<td><code>serviceProviderNameIdQualifier</code></td>
<td>If defined, will overwrite the <code>SPNameQualifier</code> attribute of the produced subject's name id.</td>
</tr>
<tr>
<td><code>skipGeneratingAssertionNameId</code></td>
<td>Whether generation of a name identifier should be skipped for assertions. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingTransientNameId</code></td>
<td>Whether transient name identifier generation should be skipped. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingSubjectConfirmationInResponseTo</code></td>
<td>Whether generation of the <code>InResponseTo</code> element should be skipped for subject confirmations. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingSubjectConfirmationNotOnOrAfter</code></td>
<td>Whether generation of the <code>NotOnOrBefore</code> element should be skipped for subject confirmations. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingSubjectConfirmationRecipient</code></td>
<td>Whether generation of the <code>Recipient</code> element should be skipped for subject confirmations. Default is <code>false</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingSubjectConfirmationNotBefore</code></td>
<td>Whether generation of the <code>NotBefore</code> element should be skipped for subject confirmations. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>skipGeneratingSubjectConfirmationNameId</code></td>
<td>Whether generation of the <code>NameID</code> element should be skipped for subject confirmations. Default is <code>true</code>.</td>
</tr>
<tr>
<td><code>signingCredentialFingerprint</code></td>
<td>
<code>SHA-1</code> digest of the signing credential's public key, parsed as a regular expression, used for the purposes of key rotation when dealing with multiple credentials.</td>
</tr>
<tr>
<td><code>signingCredentialType</code></td>
<td>Acceptable values are <code>BASIC</code> and <code>X509</code>. This setting controls the type of the signature block produced in the final SAML response for this application. The latter, being the default, encodes the signature in <code>PEM</code> format inside a <code>X509Data</code> block while the former encodes the signature based on the resolved public key under a <code>DEREncodedKeyValue</code> block.</td>
</tr>
<tr>
<td><code>signingSignatureReferenceDigestMethods</code></td>
<td>Collection of signing signature reference digest methods, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>signingKeyAlgorithm</code></td>
<td>Signing key algorithm to forcibly use for signing operations when loading the private key. Default is <code>RSA</code>.</td>
</tr>
<tr>
<td><code>signingSignatureAlgorithms</code></td>
<td>Collection of signing signature algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>signingSignatureBlackListedAlgorithms</code></td>
<td>Collection of rejected signing signature algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>signingSignatureWhiteListedAlgorithms</code></td>
<td>Collection of allowed signing signature algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>signingSignatureCanonicalizationAlgorithm</code></td>
<td>The signing signature canonicalization algorithm, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>encryptionDataAlgorithms</code></td>
<td>Collection of encryption data algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>encryptionKeyAlgorithms</code></td>
<td>Collection of encryption key transport algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>encryptionBlackListedAlgorithms</code></td>
<td>Collection of rejected encryption algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>encryptionWhiteListedAlgorithms</code></td>
<td>Collection of allowed encryption algorithms, if any, to override the global defaults.</td>
</tr>
<tr>
<td><code>whiteListBlackListPrecedence</code></td>
<td>Preference value indicating which should take precedence when both whitelist and blacklist are non-empty. Accepted values are <code>WHITELIST</code> or <code>BLACKLIST</code>. Default is <code>WHITELIST</code>.</td>
</tr>
</tbody>
</table>
<!-- raw HTML omitted -->
<h3>
<a id="metadata-aggregates" class="anchor" href="#metadata-aggregates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Metadata Aggregates</h3>
<p>CAS services are fundamentally recognized and loaded by service identifiers taught to CAS typically via<br>
regular expressions. This allows for common groupings of applications and services by<br>
url patterns (i.e. "Everything that belongs to <code>example.org</code> is registered with CAS).<br>
With aggregated metadata, CAS essentially does double<br>
authorization checks because it will first attempt to find the entity id<br>
in its collection of resolved metadata components and then it looks to<br>
see if that entity id is authorized via the pattern that is assigned to<br>
that service definition. This means you can do one of several things:</p>
<ol>
<li>Open up the pattern to allow everything that is authorized in the metadata.</li>
<li>Restrict the pattern to only a select few entity ids found in the<br>
metadata. This is essentially the same thing as defining metadata criteria<br>
to filter down the list of resolved relying parties and entity ids except that its done<br>
after the fact once the metadata is fully loaded and parsed.</li>
<li>You can also instruct CAS to filter metadata<br>
entities by a defined criteria at resolution time when it reads the<br>
metadata itself. This is essentially the same thing as forcing the pattern<br>
to match entity ids, except that it's done while CAS is reading the<br>
metadata and thus load times are improved.</li>
</ol>
<h3>
<a id="metadata-resolution" class="anchor" href="#metadata-resolution" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Metadata Resolution</h3>
<p>Service provider metadata is fetched and loaded on demand for every service and then cached in a global cache for a<br>
configurable duration. Subsequent requests for service metadata will always consult the cache first and if missed,<br>
will resort to actually resolving the metadata by loading or contacting the configured resource.<br>
Each service provider definition that is registered with CAS may optionally also specifically an expiration period of<br>
metadata resolution to override the default global value.</p>
<h4>
<a id="dynamic-metadata-resolution" class="anchor" href="#dynamic-metadata-resolution" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dynamic Metadata Resolution</h4>
<p>In addition to the more traditional means of managing service provider metadata such as direct XML files or URLs, CAS<br>
provides support for a number of other strategies to fetch metadata more dynamically with the likes of MDQ and more.<br>
To learn more, please <a href="Configuring-SAML2-DynamicMetadata.html">review this guide</a>.</p>
<h3>
<a id="security-configuration" class="anchor" href="#security-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security Configuration</h3>
<p>There are several levels of configuration that control the security configuration of objects that are signed, encrypted, etc. These configurations include things<br>
like the keys to use, preferred/default algorithms, and algorithms to allow, enforce or reject.</p>
<p>The configurations are generally determined based on the following order:</p>
<ul>
<li>Service provider metadata</li>
<li>Per-service configuration overrides</li>
<li>Global CAS default settings</li>
<li>OpenSAML initial defaults</li>
</ul>
<p>In almost all cases, you should leave the defaults in place.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#saml-algorithms--security">review this guide</a>.</p>
<h4>
<a id="encryption" class="anchor" href="#encryption" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Encryption</h4>
<p>The following examples demonstrate encryption security configuration overrides per service provider.</p>
<h4>
<a id="cbc" class="anchor" href="#cbc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CBC</h4>
<p>The following example demonstrates how to configure CAS to use <code>CBC</code> encryption for a particular service provider:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "sp.example.org",
  "name": "SAML",
  "id": 1,
  "metadataLocation": "/path/to/sp-metadata.xml",
  "encryptionDataAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2001/04/xmlenc#aes128-cbc"
    ]
  ],
  "encryptionKeyAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p"
    ]
  ]
}
</code></pre>
<h4>
<a id="gcm" class="anchor" href="#gcm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>GCM</h4>
<p>The following example demonstrates how to configure CAS to use <code>GCM</code> encryption for a particular service provider:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "sp.example.org",
  "name": "SAML",
  "id": 1,
  "metadataLocation": "/path/to/sp-metadata.xml",
  "encryptionDataAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2009/xmlenc11#aes128-gcm"
    ]
  ],
  "encryptionKeyAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p"
    ]
  ]
}
</code></pre>
<h4>
<a id="signing" class="anchor" href="#signing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Signing</h4>
<p>The following examples demonstrate signing security configuration overrides per service provider.</p>
<h5>
<a id="sha-1" class="anchor" href="#sha-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SHA-1</h5>
<p>The following example demonstrates how to configure CAS to use <code>SHA-1</code> signing and digest algorithms for a particular service provider:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "sp.example.org",
  "name": "SAML",
  "id": 1,
  "metadataLocation": "/path/to/sp-metadata.xml",
  "signingSignatureAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2000/09/xmldsig#rsa-sha1",
      "http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha1"
    ]
  ],
  "signingSignatureReferenceDigestMethods": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2000/09/xmldsig#sha1"
    ]
  ]
}
</code></pre>
<h5>
<a id="sha-256" class="anchor" href="#sha-256" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SHA-256</h5>
<p>The following example demonstrates how to configure CAS to use <code>SHA-256</code> signing and digest algorithms for a particular service provider:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "sp.example.org",
  "name": "SAML",
  "id": 1,
  "metadataLocation": "/path/to/sp-metadata.xml",
  "signingSignatureAlgorithms": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256",
      "http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256"
    ]
  ],
  "signingSignatureReferenceDigestMethods": [
    "java.util.ArrayList",
    [
      "http://www.w3.org/2001/04/xmlenc#sha256"
    ]
  ]
}
</code></pre>
<h3>
<a id="attribute-release" class="anchor" href="#attribute-release" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Attribute Release</h3>
<p>Attribute filtering and release policies are defined per SAML service. See <a href="Configuring-SAML2-Attribute-Release.html">this guide</a> for more info.</p>
<h3>
<a id="name-id-selection" class="anchor" href="#name-id-selection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Name ID Selection</h3>
<p>Each service may specify a required Name ID format. If left undefined, the metadata will be consulted to find the right format.<br>
The Name ID value is always the authenticated user that is designed to be returned to this service. In other words, if you<br>
decide to configure CAS to return a particular attribute as<br>
<a href="../integration/Attribute-Release-PrincipalId.html">the authenticated user name for this service</a>,<br>
that value will then be used to construct the Name ID along with the right format.</p>
<h4>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Examples</h4>
<p>The following service definition instructs CAS to use the <code>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</code> as the final Name ID format,<br>
and use the <code>mail</code> attribute value as the final Name ID value.</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "the-entity-id-of-the-sp",
  "name": "SAML Service",
  "metadataLocation": "/path/to/sp-metadata.xml",
  "id": 1,
  "requiredNameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.PrincipalAttributeRegisteredServiceUsernameProvider",
    "usernameAttribute" : "mail",
  }
}
</code></pre>
<p>The following service definition instructs CAS to use the <code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code> as the final Name ID format,<br>
and use the <code>cn</code> attribute value in upper-case as the final Name ID value, skipping the generation of transient value per the required format.</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "the-entity-id-of-the-sp",
  "name": "SAML Service",
  "metadataLocation": "/path/to/sp-metadata.xml",
  "id": 1,
  "requiredNameIdFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:transient",
  "skipGeneratingTransientNameId" : true,
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.PrincipalAttributeRegisteredServiceUsernameProvider",
    "usernameAttribute" : "cn",
    "canonicalizationMode" : "UPPER"
  }
}
</code></pre>
<p>The following service definition instructs CAS to use the <code>cn</code> attribute value to create a persistent Name ID.</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "the-entity-id-of-the-sp",
  "name": "SAML Service",
  "metadataLocation": "/path/to/sp-metadata.xml",
  "id": 1,
  "requiredNameIdFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.AnonymousRegisteredServiceUsernameAttributeProvider",
    "persistentIdGenerator" : {
      "@class" : "org.apereo.cas.authentication.principal.ShibbolethCompatiblePersistentIdGenerator",
      "salt" : "aGVsbG93b3JsZA==",
      "attribute": "cn"
    }
  }
}
</code></pre>
<h2>
<a id="unsolicited-sso" class="anchor" href="#unsolicited-sso" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Unsolicited SSO</h2>
<p>SAML2 IdP <code>Unsolicited/SSO</code> profile supports the following parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>providerId</code></td>
<td>Required. Entity ID of the service provider.</td>
</tr>
<tr>
<td><code>shire</code></td>
<td>Optional. Response location (ACS URL) of the service provider.</td>
</tr>
<tr>
<td><code>target</code></td>
<td>Optional. Relay state.</td>
</tr>
<tr>
<td><code>time</code></td>
<td>Optional. Skew the authentication request.</td>
</tr>
</tbody>
</table>
<h2>
<a id="attribute-queries" class="anchor" href="#attribute-queries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Attribute Queries</h2>
<p>In order to allow CAS to support and respond to attribute queries, you need to make sure the generated metadata has<br>
the <code>AttributeAuthorityDescriptor</code> element enabled, with protocol support enabled for <code>urn:oasis:names:tc:SAML:2.0:protocol</code><br>
and relevant binding that corresponds to the CAS endpoint(s). You also must ensure the <code>AttributeAuthorityDescriptor</code> tag lists all<br>
<code>KeyDescriptor</code> elements and certificates that are used for signing as well as authentication, specially if the SOAP client of the service provider<br>
needs to cross-compare the certificate behind the CAS endpoint with what is defined for the <code>AttributeAuthorityDescriptor</code>. CAS by default<br>
will always use its own signing certificate for signing of the responses generated as a result of an attribute query.</p>
<p>Also note that support for attribute queries need to be explicitly enabled and the behavior is off by default, given it imposes a burden on<br>
CAS and the underlying ticket registry to keep track of attributes and responses as tickets and have them be later used and looked up.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#saml-idp">review this guide</a>.</p>
<h2>
<a id="service-provider-integrations" class="anchor" href="#service-provider-integrations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Service Provider Integrations</h2>
<p>A number of SAML2 service provider integrations are provided natively by CAS. To learn more,<br>
please <a href="../integration/Configuring-SAML-SP-Integrations.html">review this guide</a>.</p>
<h2>
<a id="service-provider-metadata" class="anchor" href="#service-provider-metadata" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Service Provider Metadata</h2>
<p>If the SP you wish to integrate with does not produce SAML metadata, you may be able to<br>
use <a href="https://www.samltool.com/sp_metadata.php">this service</a> to create the metadata,<br>
save it in an XML file and then reference and register it with CAS for the SP.</p>
<p>Alternatively, you may take advantage of a standalone <code>saml-sp-metadata.json</code> file that may be found in the same directory<br>
as the CAS metadata artifacts. The contents of this file may be as follows:</p>
<pre lang="json"><code>{
  "https://example.org/saml": {
    "entityId": "https://example.org/saml",
    "certificate": "MIIDUj...",
    "assertionConsumerServiceUrl": "https://example.org/sso/"
  }
}
</code></pre>
<p>Each entry in the file is identified by the service provider entity id, allowing CAS to dynamically locate and build the required metadata on the fly<br>
to resume the authentication flow. This may prove easier for those service providers that only present a URL and a signing certificate for the<br>
integration relieving you from creating and managing XML metadata files separately.</p>
<p>The service providers are registered with the CAS service registry as such:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId" : "https://example.org/saml",
  "name" : "SAMLService",
  "id" : 10000003,
  "metadataLocation" : "json://"
}
</code></pre>
<!-- raw HTML omitted -->
<h2>
<a id="client-libraries" class="anchor" href="#client-libraries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Client Libraries</h2>
<p>For Java-based applications, the following frameworks may be used to integrate your application with CAS acting as a SAML2 identity provider:</p>
<ul>
<li><a href="http://projects.spring.io/spring-security-saml/">Spring Security SAML</a></li>
<li><a href="http://www.pac4j.org/docs/clients/saml.html">Pac4j</a></li>
</ul>
<h2>
<a id="sample-client-applications" class="anchor" href="#sample-client-applications" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample Client Applications</h2>
<ul>
<li><a href="https://github.com/cas-projects/saml2-sample-java-webapp">Spring Security SAML Sample Webapp</a></li>
<li><a href="https://developer.okta.com/standards/SAML/setting_up_a_saml_application_in_okta">Okta</a></li>
</ul>
<h2>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h2>
<p>To enable additional logging, modify the logging configuration file to add the following:</p>
<pre lang="xml"><code>&lt;Logger name="org.opensaml" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/Logger&gt;
&lt;Logger name="PROTOCOL_MESSAGE" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/Logger&gt;
</code></pre>