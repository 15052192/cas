<hr>
<h2>
<a id="layout-defaulttitle-cas---jwt-service-ticketscategory-ticketing" class="anchor" href="#layout-defaulttitle-cas---jwt-service-ticketscategory-ticketing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - JWT Service Tickets<br>
category: Ticketing</h2>
<h1>
<a id="jwt-service-tickets" class="anchor" href="#jwt-service-tickets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JWT Service Tickets</h1>
<p><a href="http://jwt.io/">JSON Web Tokens</a> are an open, industry standard RFC 7519 method for representing claims securely between two parties.<br>
CAS may also be allowed to fully create signed/encrypted JWTs and pass them back to the application in form of service tickets.</p>
<p>JWTs are entirely self-contained and contain the authenticated principal as well as all authorized attributes in form of JWT claims.</p>
<!-- raw HTML omitted -->
<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>
<p>JWT-based service tickets are issued to application based on the same semantics defined by the <a href="../protocol/CAS-Protocol.html">CAS Protocol</a>.<br>
CAS having received an authentication request via its <code>/login</code> endpoint will conditionally issue back <code>JWT</code> service tickets to the<br>
application in form of a <code>ticket</code> parameter via the requested http method.</p>
<p>All JWTs are by default signed and encrypted by CAS based on keys generated and controlled during deployment. Such keys may be<br>
exchanged with client applications to unpack the JWT and access claims.</p>
<h2>
<a id="flow-diagram" class="anchor" href="#flow-diagram" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Flow Diagram</h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>Note that per the above diagram, the JWT request by default internally causes CAS to generate an <code>ST</code> for the application and immediately then validate it in<br>
order to get access to the authenticated principal and attributes per policies associated with the application registration record in the<br>
CAS service registry. This response is transformed into a <code>JWT</code> that is then passed onto the client application.</p>
<p>In other words, the responsibility of receiving a service ticket (<code>ST</code>) and validating it is all moved into and handled internally by CAS.<br>
The application only needs to learn how to decipher and unpack the final <code>JWT</code> and ensure its validity.</p>
<p>The expiration time of the generated <code>JWT</code> is controlled by the length of the assertion returned as part of the validation event. If the<br>
assertion validity length is not specified, then the expiration time is controlled by the length of the SSO session defined as part of SSO expiration policy of the CAS server.</p>
<!-- raw HTML omitted -->
<h2>
<a id="administrative-endpoints" class="anchor" href="#administrative-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Administrative Endpoints</h2>
<p>The following endpoints are provided by CAS:</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jwtTicketSigningPublicKey</code></td>
<td>Exposes the signing public key, accepting an optional <code>service</code> parameter.</td>
</tr>
</tbody>
</table>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>JWT support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-token-tickets" %}</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#jwt-tickets">review this guide</a>.</p>
<h3>
<a id="register-clients" class="anchor" href="#register-clients" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Register Clients</h3>
<p>Signal the relevant application in CAS service registry to produce JWTs for service tickets:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^https://.*",
  "name" : "Sample",
  "id" : 10,
  "properties" : {
    "@class" : "java.util.HashMap",
    "jwtAsServiceTicket" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "true" ] ]
    }
  }
}
</code></pre>
<h3>
<a id="configure-keys-per-service" class="anchor" href="#configure-keys-per-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure Keys Per Service</h3>
<p>By default, the signing and encryption keys used to encode the JWT are global to the CAS server and can be defined via CAS settings. It is also possible<br>
to override the global keys on a per-service basis, allowing each application to use its own set of signing and encryption keys. To do so, configure<br>
the service definition in the registry to match the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^https://.*",
  "name" : "Sample",
  "id" : 10,
  "properties" : {
    "@class" : "java.util.HashMap",
    "jwtAsServiceTicket" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "true" ] ]
    },
    "jwtAsServiceTicketSigningKey" : {
       "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
       "values" : [ "java.util.HashSet", [ "..." ] ]
    },
    "jwtAsServiceTicketEncryptionKey" : {
         "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
         "values" : [ "java.util.HashSet", [ "..." ] ]
    },
    "jwtAsServiceTicketCipherStrategyType" : {
         "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
         "values" : [ "java.util.HashSet", [ "ENCRYPT_AND_SIGN" ] ]
    }
  }
}
</code></pre>
<p>The following cipher strategy types are available:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENCRYPT_AND_SIGN</code></td>
<td>Default strategy; encrypt values, and then sign.</td>
</tr>
<tr>
<td><code>SIGN_AND_ENCRYPT</code></td>
<td>Sign values, and then encrypt.</td>
</tr>
</tbody>
</table>
<h2>
<a id="jwt-validation---aes" class="anchor" href="#jwt-validation---aes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JWT Validation - AES</h2>
<p>The following <em>example</em> code snippet demonstrates how one might go about validating and parsing the CAS-produced JWT<br>
that is created using shared secrets via <code>AES</code>:</p>
<pre lang="java"><code>import org.apache.commons.codec.binary.Base64;
import org.jose4j.jwe.JsonWebEncryption;
import org.jose4j.jwk.JsonWebKey;
import org.jose4j.jws.JsonWebSignature;
import org.jose4j.keys.AesKey;

import java.nio.charset.StandardCharsets;
import java.security.Key;

...

final String signingKey = "...";
final String encryptionKey = "...";

final Key key = new AesKey(signingKey.getBytes(StandardCharsets.UTF_8));

final JsonWebSignature jws = new JsonWebSignature();
jws.setCompactSerialization(secureJwt);
jws.setKey(key);
if (!jws.verifySignature()) {
    throw new Exception("JWT verification failed");
}

final byte[] decodedBytes = Base64.decodeBase64(jws.getEncodedPayload().getBytes(StandardCharsets.UTF_8));
final String decodedPayload = new String(decodedBytes, StandardCharsets.UTF_8);

final JsonWebEncryption jwe = new JsonWebEncryption();
final JsonWebKey jsonWebKey = JsonWebKey.Factory
    .newJwk("\n" + "{\"kty\":\"oct\",\n" + " \"k\":\"" + encryptionKey + "\"\n" + "}");

jwe.setCompactSerialization(decodedPayload);
jwe.setKey(new AesKey(jsonWebKey.getKey().getEncoded()));
System.out.println(jwe.getPlaintextString());
</code></pre>