<hr>
<h2>
<a id="layout-defaulttitle-cas---qr-code-authenticationcategory-authentication" class="anchor" href="#layout-defaulttitle-cas---qr-code-authenticationcategory-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - QR Code Authentication<br>
category: Authentication</h2>
<h1>
<a id="qr-code-authentication" class="anchor" href="#qr-code-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>QR Code Authentication</h1>
<p>QR Code authentication is a strategy that allows the user to scan a QR code, generated by the<br>
CAS server, using a mobile device and subsequently login after having successfully validated it.</p>
<p>The QR code contains a special identifier embedded within that allows the mobile device to establish a communication<br>
channel using web sockets to the CAS server. Once established, the mobile device may collect credentials from the user<br>
and submit those to CAS for verification. The return result, expected as a <code>JWT</code> that is generated by CAS,<br>
is then passed along to the web socket channel for verification and successful login. Subsequent login attempts can allow<br>
for a completely <em>passwordless</em> scenario such that the mobile device can continue to re-use the JWT<br>
for authentication attempts, allowing the end user to <em>scan and proceed</em>.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<pre lang="xml"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
  &lt;artifactId&gt;cas-server-support-qrlogin&lt;/artifactId&gt;
  &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2>
<a id="administrative-endpoints" class="anchor" href="#administrative-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Administrative Endpoints</h2>
<p>The following endpoints are provided by CAS:</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>qrDevices/{username}</code></td>
<td>
<code>GET</code> request to fetch device for the user.</td>
</tr>
<tr>
<td><code>qrDevices/{username}/{device}</code></td>
<td>
<code>POST</code> request to register a device with CAS.</td>
</tr>
<tr>
<td><code>qrDevices/{username}/{device}</code></td>
<td>
<code>DELETE</code> request to delete a device for the user.</td>
</tr>
</tbody>
</table>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>To see the relevant list of CAS<br>
properties, please <a href="../configuration/Configuration-Properties.html#qr-authentication">review this guide</a>.</p>
<h2>
<a id="web-socket-communication" class="anchor" href="#web-socket-communication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Web Socket Communication</h2>
<p>The process of connecting to a web socket connection certainly varies for each mobile app framework. At a high level,<br>
mobile devices should establish a web socket connection to the CAS server via the <code>/cas/qr-websocket</code> endpoint.<br>
The payload must then be sent to the <code>/qr/accept</code> path as a map and must contain a <code>token</code> field that<br>
carries the pre-authenticated JWT. The payload header must point to the channel id obtained<br>
from the QR code under the header name <code>QR_AUTHENTICATION_CHANNEL_ID</code> as well<br>
as the authorized device identifier under <code>QR_AUTHENTICATION_DEVICE_ID</code>.</p>
<p>The following code snippet demonstrates this process as an example:</p>
<pre lang="javascript"><code>let socket = new SockJS('https://sso.example.org/cas/qr-websocket');
let stompClient = Stomp.over(socket);
let payload = JSON.stringify({'token': '...'});   
let channelId = "...";      
let deviceId = "...";
stompClient.send("/qr/accept", 
    {'QR_AUTHENTICATION_CHANNEL_ID': channelId, 
     'QR_AUTHENTICATION_DEVICE_ID': deviceId}, 
    payload);
</code></pre>
<p>The following code snippet demonstrates this process for<br>
the Android platform based on <a href="https://github.com/NaikSoftware/StompProtocolAndroid">StompProtocolAndroid</a>:</p>
<pre lang="java"><code>import ua.naiksoftware.stomp.*;
import ua.naiksoftware.stomp.dto.*;

String jwt = "...";
JSONStringer jsonWebToken = new JSONStringer().object()
  .key("token").value(jwt).endObject();

String channel = "...";      
String deviceId = "...";
List&lt;StompHeader&gt; headers = new ArrayList&lt;&gt;();
headers.add(new StompHeader("QR_AUTHENTICATION_CHANNEL_ID", channel));
headers.add(new StompHeader("QR_AUTHENTICATION_DEVICE_ID", deviceId));
headers.add(new StompHeader(StompHeader.DESTINATION, "/qr/accept"));

// wss://10.0.2.2 for ssl and localhost
StompClient client = Stomp.over(Stomp.ConnectionProvider.OKHTTP, 
  "wss://10.0.2.2:8443/cas/qr-websocket/websocket", null, httpClient);

client.connect();
StompMessage stompMessage = 
  new StompMessage(StompCommand.SEND, headers, jsonWebToken.toString());
client.send(stompMessage).subscribe();
</code></pre>
<h2>
<a id="obtaining-jwt" class="anchor" href="#obtaining-jwt" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Obtaining JWT</h2>
<p>The mobile device should ask for and then submit user credentials to the CAS<br>
server using the <a href="../protocol/REST-Protocol.html#jwt-ticket-granting-tickets">REST protocol</a> to<br>
obtain a JWT. The JWT request must also contain an additional request<br>
parameter <code>QR_AUTHENTICATION_DEVICE_ID</code> which indicates the authorized device identifier for the user.</p>
<p>Once the JWT is received, the device may cache the JWT and establish a <em>session</em> for code reuse later.<br>
The JWT should be sent to the CAS server's web socket channel for validation and login as demonstrated above. The generated<br>
JWT is automatically signed and encrypted by CAS and can only be decoded by the CAS server.</p>
<h2>
<a id="web-socket-channel" class="anchor" href="#web-socket-channel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Web Socket Channel</h2>
<p>The QR code contains a special identifier embedded within that allows the mobile device to establish<br>
a communication channel using web sockets to the CAS server. The mobile device must be able<br>
to scan the QR code  to extract the channel id in order to establish a<br>
communication route between CAS and the device.</p>
<h2>
<a id="mobile-device-authorization" class="anchor" href="#mobile-device-authorization" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mobile Device Authorization</h2>
<p>Registered devices are authorized and accepted by CAS using a dedicated QR device repository, that is able to<br>
track and link device identifiers to user ids. Such devices must be registered with CAS using an<br>
external registration mechanism or via available CAS-provided APIs.</p>
<p>By default, all devices can authenticate using the QR code. Different device repository<br>
implementations can be supplied using one of the strategies outlined below.</p>
<h3>
<a id="json" class="anchor" href="#json" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JSON</h3>
<p>Authorized devices can be managed and tracked inside a single JSON resource, whose path is taught to CAS via settings. To see the<br>
relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#qr-authentication">review this guide</a>.</p>
<h3>
<a id="custom" class="anchor" href="#custom" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom</h3>
<p>Provide the appropriate bean implementation below to define a custom strategy for managing registered devices.</p>
<pre lang="java"><code>@Bean
public QRAuthenticationDeviceRepository qrAuthenticationDeviceRepository() {
    return ...
}
</code></pre>