<hr>
<h2>
<a id="layout-defaulttitle-cas---consul-service-discoverycategory-high-availability" class="anchor" href="#layout-defaulttitle-cas---consul-service-discoverycategory-high-availability" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Consul Service Discovery<br>
category: High Availability</h2>
<p>{% include variables.html %}</p>
<h1>
<a id="consul-server-discovery-service" class="anchor" href="#consul-server-discovery-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Consul Server Discovery Service</h1>
<p><a href="https://www.consul.io">HashiCorp Consul</a> has multiple components, but as a whole, it is a tool for discovering and configuring services in your infrastructure. It provides key features:</p>
<ul>
<li>
<p><strong>Service Discovery</strong>: Clients of Consul can provide a service, such as api or mysql, and other clients can use Consul to discover providers of a given service. Using either DNS or HTTP, applications can easily find the services they depend upon.</p>
</li>
<li>
<p><strong>Health Checking</strong>: Consul clients can provide any number of health checks, either associated with a given service ("is the webserver returning 200 OK"), or with the local node ("is memory utilization below 90%"). This information can be used by an operator to monitor cluster health, and it is used by the service discovery components to route traffic away from unhealthy hosts.</p>
</li>
<li>
<p><strong>KV Store</strong>: Applications can make use of Consul's hierarchical key/value store for any number of purposes, including dynamic configuration, feature flagging, coordination, leader election, and more. The simple HTTP API makes it easy to use.</p>
</li>
<li>
<p><strong>Multi Datacenter</strong>: Consul supports multiple datacenters out of the box. This means users of Consul do not have to worry about building additional layers of abstraction to grow to multiple regions.</p>
</li>
</ul>
<p>CAS provides a Consul-enabled service discovery server that is based on <a href="https://cloud.spring.io/spring-cloud-consul/">Spring Cloud Consul</a> and bootstrapped via <a href="http://cloud.spring.io/spring-cloud-static/spring-cloud.html">Spring Cloud</a>.</p>
<h3>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h3>
<ul>
<li>To run the Consul discovery server, please <a href="https://www.consul.io/">see this guide</a> for installation instructions. A simple Consul installation may be run as <code>consul agent -dev -ui</code>
</li>
<li>Look for a suitable and relevant ready-made Docker image via <code>docker search consul</code>.</li>
</ul>
<p>When deployed and assuming default settings, the Consul dashboard would be available at: <code>http://localhost:8500/ui</code>.</p>
<p>Note that a Consul Agent client must be available to all CAS server nodes. By default, the agent client is expected to be at <code>localhost:8500</code>. See the <a href="https://consul.io/docs/agent/basics.html">Agent documentation</a> for specifics on how to start an Agent client.</p>
<h3>
<a id="configuration-management" class="anchor" href="#configuration-management" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration Management</h3>
<p>Consul provides a <a href="https://consul.io/docs/agent/http/kv.html">Key/Value Store</a> for storing configuration and other metadata. Configuration is loaded into the CAS environment during the special "bootstrap" phase at runtime. Configuration is stored in the <code>/config</code> folder by default. Multiple <code>PropertySource</code> instances are created based on the applicationâ€™s name and the active profiles that mimics<br>
the Spring Cloud Config order of resolving properties. For example, an application with the name <code>cas</code> and with the <code>dev</code> profile will have the following property sources created:</p>
<pre lang="bash"><code>config/cas,dev/
config/cas/
config/application,dev/
config/application/
</code></pre>
<p>The most specific property source is at the top, with the least specific at the bottom. Properties in the <code>config/application</code> folder are applicable to all applications using consul for configuration. Properties in the <code>config/cas</code> folder are only available to the instances of the service named <code>cas</code>.</p>
<p>Configuration is currently read on startup of the application. Sending a HTTP POST to <code>/refresh</code> will cause the configuration to be reloaded. Watching the key value store (which Consul supports) is not currently possible, but will be a future addition to this project.</p>
<p>The Consul Config Watch takes advantage of the ability of consul to <a href="https://www.consul.io/docs/agent/watches.html">watch a key prefix</a>. The Config Watch makes a blocking Consul HTTP API call to determine if any relevant configuration data has changed for the current application. If there is new configuration data a <code>Refresh Event</code> is published. This is equivalent to calling the <code>/refresh</code> Spring Boot actuator endpoint.</p>
<h2>
<a id="cas-discovery-service-clients" class="anchor" href="#cas-discovery-service-clients" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CAS Discovery Service Clients</h2>
<p>Each individual CAS server is given the ability to auto-register itself with the discovery server, provided configuration is made available to instruct the CAS server how to locate and connect to the discover server service.</p>
<p>Support is added by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-consul-client" %}</p>
<p>To see the relevant list of CAS properties,<br>
please <a href="../configuration/Configuration-Properties.html#consul-service-discovery">review this guide</a>.</p>
<h3>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h3>
<p>To enable additional logging, configure the log4j configuration file to add the following levels:</p>
<pre lang="xml"><code>&lt;Logger name="org.springframework.cloud.consul" level="debug" additivity="false"&gt;
  &lt;AppenderRef ref="casConsole"/&gt;
  &lt;AppenderRef ref="casFile"/&gt;
&lt;/Logger&gt;
</code></pre>