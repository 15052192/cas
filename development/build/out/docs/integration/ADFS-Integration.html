<hr>
<h2>
<a id="layout-defaulttitle-cas---adfs-integrationcategory-authentication" class="anchor" href="#layout-defaulttitle-cas---adfs-integrationcategory-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - ADFS Integration<br>
category: Authentication</h2>
<p>{% include variables.html %}</p>
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>The integration between the CAS Server and ADFS delegates user authentication from CAS Server<br>
to ADFS, making CAS Server a WS-Federation client. Claims released from ADFS are made<br>
available as attributes to CAS Server, and by extension CAS Clients.</p>
<!-- raw HTML omitted -->
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-wsfederation-webflow" %}</p>
<p>You may also need to declare the following repository in your<br>
CAS Overlay to be able to resolve dependencies:</p>
<pre lang="groovy"><code>repositories {
    maven { 
        mavenContent { releasesOnly() }
        url "https://build.shibboleth.net/nexus/content/repositories/releases" 
    }
}
</code></pre>
<!-- raw HTML omitted -->
<h2>
<a id="wsfed-configuration" class="anchor" href="#wsfed-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>WsFed Configuration</h2>
<p>Adjust and provide settings for the ADFS instance, and make sure you have obtained the ADFS<br>
signing certificate and made it available to CAS at a location that can be resolved at runtime.</p>
<p>{% include {{ version }}/wsfed-delegated-authentication.md configKey="cas.authn.wsfed[0]" %}</p>
<h2>
<a id="encrypted-assertions" class="anchor" href="#encrypted-assertions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Encrypted Assertions</h2>
<p>CAS is able to automatically decrypt SAML assertions that are issued by ADFS. To do this,<br>
you will first need to generate a private/public keypair:</p>
<pre lang="bash"><code>openssl genrsa -out private.key 1024
openssl rsa -pubout -in private.key -out public.key -inform PEM -outform DER
openssl pkcs8 -topk8 -inform PER -outform DER -nocrypt -in private.key -out private.p8
openssl req -new -x509 -key private.key -out x509.pem -days 365

# convert the X509 certificate to DER format
openssl x509 -outform der -in x509.pem -out certificate.crt
</code></pre>
<p>Configure CAS to reference the keypair, and configure the relying party trust settings<br>
in ADFS to use the <code>certificate.crt</code> file for encryption.</p>
<h2>
<a id="modifying-adfs-claims" class="anchor" href="#modifying-adfs-claims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Modifying ADFS Claims</h2>
<p>The WsFed configuration optionally may allow you to manipulate claims coming from ADFS but before they are inserted into the CAS user principal.<br>
The manipulation of the attributes is carried out using an <em>attribute mutator</em> where its logic may be implemented inside a Groovy script and whose<br>
path is taught to CAS via settings.</p>
<p>The script may take on the following form:</p>
<pre lang="groovy"><code>import org.apereo.cas.*
import java.util.*
import org.apereo.cas.authentication.*

def Map run(final Object... args) {
    def attributes = args[0]
    def logger = args[1]
    logger.warn("Mutating attributes {}", attributes)
    return [upn: ["CASUser"]]
}
</code></pre>
<p>The parameters passed to the script are as follows:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>attributes</code></td>
<td>A current <code>Map</code> of attributes provided from ADFS.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<p>Note that the execution result of the script <em>MUST</em> ensure that attributes are collected into a <code>Map</code><br>
where the attribute name, the key, is a simple <code>String</code> and the attribute value is transformed into a collection.</p>
<h2>
<a id="handling-cas-logout" class="anchor" href="#handling-cas-logout" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Handling CAS Logout</h2>
<p>An optional step, the <code>casLogoutView.html</code> can be modified to place a link to ADFS's logout page.</p>
<pre lang="html"><code>&lt;a href="https://adfs.example.org/adfs/ls/?wa=wsignout1.0"&gt;Logout&lt;/a&gt;
</code></pre>
<p>Alternatively, you may simply instruct CAS to redirect to the above endpoint after logout operations have executed.<br>
To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#logout">review this guide</a>.</p>
<h2>
<a id="per-service-relying-party-id" class="anchor" href="#per-service-relying-party-id" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Per-Service Relying Party Id</h2>
<p>In order to specify a relying party identifier per service definition, adjust your service<br>
registry to match the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^https://.+",
  "name" : "sample service",
  "id" : 100,
  "properties" : {
    "@class" : "java.util.HashMap",
    "wsfed.relyingPartyIdentifier" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "custom-identifier" ] ]
    }
  }
}
</code></pre>
<h2>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h2>
<p>Be aware of clock drift issues between CAS and the ADFS server. Validation failures of the response do show up in the logs, and the request is routed back to<br>
ADFS again, causing redirect loops.</p>