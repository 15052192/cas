<hr>
<h2>
<a id="layout-defaulttitle-cas---releasing-principal-idcategory-attributes" class="anchor" href="#layout-defaulttitle-cas---releasing-principal-idcategory-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Releasing Principal Id<br>
category: Attributes</h2>
<h1>
<a id="principal-id-attribute" class="anchor" href="#principal-id-attribute" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Principal-Id Attribute</h1>
<p>Registered CAS applications are given the ability to allow for configuration of a<br>
username attribute provider, which controls what should be the designated user identifier<br>
that is returned to the application. The user identifier by default is the authenticated CAS principal id, yet it optionally may be based off of an existing<br>
attribute that is available and resolved for the principal already. More practically, this component determines what should be placed inside the <code>&lt;cas:user&gt;</code><br>
tag in the final CAS validation payload that is returned to the application.</p>
<!-- raw HTML omitted -->
<p>A number of providers are able to perform canonicalization on the final user id returned to transform it<br>
into uppercase/lowercase. This is noted by the <code>canonicalizationMode</code> whose allowed values are <code>UPPER</code>, <code>LOWER</code> or <code>NONE</code>.</p>
<h2>
<a id="default" class="anchor" href="#default" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default</h2>
<p>The default configuration which need not explicitly be defined, returns the resolved<br>
principal id as the username for this service.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 100,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceUsernameProvider",
    "canonicalizationMode" : "NONE"
  }
}
</code></pre>
<p>If you do not need to adjust the behavior of this provider (i.e. to modify the <code>canonicalization</code> mode),<br>
then you can leave out this block entirely.</p>
<h2>
<a id="encrypted" class="anchor" href="#encrypted" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Encrypted</h2>
<p>Most if not all providers are able to encrypt the resolved username, assuming the service definition is given a public key.</p>
<p>The key can be generated via the following commands:</p>
<pre lang="bash"><code>openssl genrsa -out private.key 1024
openssl rsa -pubout -in private.key -out public.key -inform PEM -outform DER
openssl pkcs8 -topk8 -inform PER -outform DER -nocrypt -in private.key -out private.p8
</code></pre>
<p>The public key is then configured for a service definition in CAS:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 100,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceUsernameProvider",
    "encryptUsername" : "true"
  },
  "publicKey" : {
    "@class" : "org.apereo.cas.services.RegisteredServicePublicKeyImpl",
    "location" : "classpath:public.key",
    "algorithm" : "RSA"
  }
}
</code></pre>
<p>The configuration of the public key component qualifies to use the <a href="../configuration/Configuration-Spring-Expressions.html">Spring Expression Language</a> syntax.</p>
<p>The application can then proceed to decrypt the username using its own private key.<br>
The following sample code demonstrates how that might be done in Java:</p>
<pre lang="java"><code>final String casUsername = ...
final PrivateKey privateKey = ...
final Cipher cipher = Cipher.getInstance(privateKey.getAlgorithm());
final byte[] cred64 = decodeBase64(encodedPsw);
cipher.init(Cipher.DECRYPT_MODE, privateKey);
final byte[] cipherData = cipher.doFinal(casUsername);
return new String(cipherData);
</code></pre>
<h2>
<a id="attribute" class="anchor" href="#attribute" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Attribute</h2>
<p>Returns an attribute that is already resolved for the principal as the username for this service. If the attribute<br>
is not available, the default principal id will be used.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 600,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.PrincipalAttributeRegisteredServiceUsernameProvider",
    "usernameAttribute" : "cn",
    "canonicalizationMode" : "UPPER"
  }
}
</code></pre>
<h2>
<a id="javascriptpythongroovy-script" class="anchor" href="#javascriptpythongroovy-script" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Javascript/Python/Groovy Script</h2>
<!-- raw HTML omitted -->
<p>Let an external javascript, groovy or python script decide how the principal id attribute should be determined.<br>
This approach takes advantage of scripting functionality built into the Java platform.<br>
While Javascript and Groovy should be natively supported by CAS, Python scripts may need<br>
to massage the CAS configuration to include the <a href="http://search.maven.org/#search%7Cga%7C1%7Ca%3A%22jython-standalone%22">Python modules</a>.</p>
<p>Scripts will receive and have access to the following variable bindings:</p>
<ul>
<li>
<code>id</code>: The existing identifier for the authenticated principal.</li>
<li>
<code>attributes</code>: A map of attributes currently resolved for the principal.</li>
<li>
<code>logger</code>: A logger object, able to provide <code>logger.info()</code> operations, etc.</li>
</ul>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 500,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.ScriptedRegisteredServiceUsernameProvider",
    "script" : "file:///etc/cas/sampleService.[groovy|js|.py]",
    "canonicalizationMode" : "UPPER"
  }
}
</code></pre>
<p>Sample Groovy script follows:</p>
<pre lang="groovy"><code>def run(Object[] args) {
    def attributes = args[0]
    def id = args[1]
    def logger = args[2]
    logger.info("Testing username attribute")
    return "test"
}
</code></pre>
<p>Sample javascript function follows:</p>
<pre lang="javascript"><code>function run(uid, logger) {
   return "test"
}
</code></pre>
<h2>
<a id="groovy" class="anchor" href="#groovy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy</h2>
<p>Returns a username attribute value as the final result of a groovy script's execution.<br>
Groovy scripts whether inlined or external will receive and have access to the following variable bindings:</p>
<ul>
<li>
<code>id</code>: The existing identifier for the authenticated principal.</li>
<li>
<code>attributes</code>: A map of attributes currently resolved for the principal.</li>
<li>
<code>service</code>: The service object that is matched by the registered service definition.</li>
<li>
<code>logger</code>: A logger object, able to provide <code>logger.info(...)</code> operations, etc.</li>
</ul>
<h3>
<a id="inline" class="anchor" href="#inline" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Inline</h3>
<p>Embed the groovy script directly inside the service configuration.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 600,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.GroovyRegisteredServiceUsernameProvider",
    "groovyScript" : "groovy { return attributes['uid'][0] + '123456789' }",
    "canonicalizationMode" : "UPPER"
  }
}
</code></pre>
<p>Note that the <code>uid</code> attribute in the above example is resolved internally as a multivalued attribute, as should all attributes when fetched by CAS. So<br>
the above example uses the <code>[0]</code> syntax to fetch the first value of the attribute.</p>
<h3>
<a id="external" class="anchor" href="#external" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>External</h3>
<p>Reference the groovy script as an external resource outside the service configuration.<br>
The script must return a single <code>String</code> value.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 600,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.GroovyRegisteredServiceUsernameProvider",
    "groovyScript" : "file:///etc/cas/sampleService.groovy",
    "canonicalizationMode" : "UPPER"
  }
}
</code></pre>
<p>Sample Groovy script follows:</p>
<pre lang="groovy"><code>logger.info("Choosing username attribute out of attributes $attributes")
return "newPrincipalId"
</code></pre>
<p>The configuration of this component qualifies to use the <a href="../configuration/Configuration-Spring-Expressions.html">Spring Expression Language</a> syntax.</p>
<h2>
<a id="anonymous--transient" class="anchor" href="#anonymous--transient" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Anonymous / Transient</h2>
<p>Provides an opaque identifier for the username.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 500,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.AnonymousRegisteredServiceUsernameAttributeProvider"
  }
}
</code></pre>
<h2>
<a id="anonymous--persistent" class="anchor" href="#anonymous--persistent" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Anonymous / Persistent</h2>
<p>Provides an opaque identifier for the username. The opaque identifier by default conforms to the requirements<br>
of the <a href="https://spaces.at.internet2.edu/display/federation/Persistent+Identifier+Support">eduPersonTargetedID</a> attribute.<br>
The generated id may be based off of an existing principal attribute. If left unspecified or attribute not found, the authenticated principal id is used.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 500,
  "description" : "sample",
  "usernameAttributeProvider" : {
    "@class" : "org.apereo.cas.services.AnonymousRegisteredServiceUsernameAttributeProvider",
    "persistentIdGenerator" : {
      "@class" : "org.apereo.cas.authentication.principal.ShibbolethCompatiblePersistentIdGenerator",
      "salt" : "aGVsbG93b3JsZA==",
      "attribute": ""
    }
  }
}
</code></pre>
<p>To simulate the behavior, you may also try the following command:</p>
<pre lang="bash"><code>perl -e 'use Digest::SHA qw(sha1_base64); \
    $digest = sha1_base64("$SERVICE!$USER!$SALT"); \
    $eqn = length($digest) % 4; print $digest; print "=" x (4-$eqn) . "\n"' 
</code></pre>
<p>Replace <code>$SERVICE</code> (the url of the application under test), <code>$USER</code> and <code>$SALT</code> with the appropriate values for the test.</p>