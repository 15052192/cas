<hr>
<h2>
<a id="layout-defaulttitle-cas---delegate-authenticationcategory-authentication" class="anchor" href="#layout-defaulttitle-cas---delegate-authenticationcategory-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - Delegate Authentication<br>
category: Authentication</h2>
<h1>
<a id="delegated-authentication" class="anchor" href="#delegated-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Delegated Authentication</h1>
<p>CAS can act as a client (i.e. service provider or proxy) using<br>
the <a href="https://github.com/pac4j/pac4j">Pac4j library</a> and delegate the authentication to:</p>
<ul>
<li>CAS servers</li>
<li>SAML2 identity providers</li>
<li>OAuth2 providers such as Facebook, Twitter, GitHub, Google, LinkedIn, etc</li>
<li>OpenID Connect identity providers such as Google, Apple</li>
<li><a href="ADFS-Integration.html">ADFS</a></li>
</ul>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-pac4j-webflow&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<!-- raw HTML omitted -->
<h2>
<a id="register-providers" class="anchor" href="#register-providers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Register Providers</h2>
<p>An identity provider is a server which can authenticate users (like Google, Yahoo...) instead of a CAS server.<br>
If you want to delegate the CAS authentication to Twitter for example, you have to add an<br>
OAuth client for the Twitter provider, which will be done automatically for you once provider settings are taught to CAS.</p>
<p>Notice that for each OAuth provider, the CAS server is considered as an OAuth client and therefore should be declared as<br>
an OAuth client at the OAuth provider. After the declaration, a key and a secret is given by the OAuth provider which has<br>
to be defined in the CAS configuration as well.</p>
<h3>
<a id="default" class="anchor" href="#default" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default</h3>
<p>Identity providers for delegated authentication can be registered with CAS using settings. To see the relevant list of<br>
CAS properties, please <a href="../configuration/Configuration-Properties.html#pac4j-delegated-authn">review this guide</a>.</p>
<h3>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h3>
<p>Identity providers for delegated authentication can be provided to CAS using an external REST endpoint. This allows the CAS server to reach to<br>
a remote REST endpoint whose responsibility is to produce the following payload in the response body:</p>
<pre lang="json"><code>{
    "callbackUrl": "https://sso.example.org/cas/login",
    "properties": {
        "github.id": "...",
        "github.secret": "...",
        
        "cas.loginUrl.1": "...",
        "cas.protocol.1": "..."
    }
}
</code></pre>
<p>The syntax and collection of available <code>properties</code> in the above payload is controlled by [Pac4j]((<a href="https://pac4j.org/docs/index.html">https://pac4j.org/docs/index.html</a>).<br>
The response that is returned must be accompanied by a 200 status code.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#pac4j-delegated-authn">review this guide</a>.</p>
<h2>
<a id="user-interface" class="anchor" href="#user-interface" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>User Interface</h2>
<p>All available clients are automatically displayed on the login page as clickable buttons.<br>
CAS does allow options for auto-redirection of the authentication flow to a provider,<br>
if only there is a single provider available and configured.</p>
<h2>
<a id="authenticated-user-id" class="anchor" href="#authenticated-user-id" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authenticated User Id</h2>
<p>After a successful delegated authentication, a user is created inside the CAS server with a specific identifier:<br>
this one can be created only from the technical identifier received from the external identity provider (like <code>1234</code>)<br>
or as a "typed identifier" (like <code>FacebookProfile#1234</code>), which is the default.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#pac4j-delegated-authn">review this guide</a>.</p>
<h2>
<a id="returned-payload" class="anchor" href="#returned-payload" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Returned Payload</h2>
<p>Once you have configured (see information above) your CAS server to act as an OAuth,<br>
CAS, OpenID (Connect) or SAML client, users will be able to authenticate at a OAuth/CAS/OpenID/SAML<br>
provider (like Facebook) instead of authenticating directly inside the CAS server.</p>
<p>In the CAS server, after this kind of delegated authentication, users have specific authentication data. These include:</p>
<ul>
<li>An identifier which is the profile type + <code>#</code> + the identifier of the user for this provider (i.e <code>FacebookProfile#0000000001</code>)</li>
<li>Attributes populated by the data retrieved from the provider (first name, last name, birthdate...)</li>
</ul>
<h2>
<a id="profile-attributes" class="anchor" href="#profile-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Profile Attributes</h2>
<p>In CAS-protected applications, through service ticket validation, user information<br>
are pushed to the CAS client and therefore to the application itself.</p>
<p>The identifier of the user is always pushed to the CAS client. For user attributes, it involves both the configuration<br>
at the server and the way of validating service tickets.</p>
<p>On CAS server side, to push attributes to the CAS client, it should be configured in the expected service:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 100,
  "description" : "sample",
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy",
    "allowedAttributes" : [ "java.util.ArrayList", [ "name", "first_name", "middle_name" ] ]
  }
}
</code></pre>
<h2>
<a id="access-strategy" class="anchor" href="#access-strategy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Access Strategy</h2>
<p>Service definitions may be conditionally authorized to use an external identity provider by defining their own access strategy and policy:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 100,
  "accessStrategy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy",
    "delegatedAuthenticationPolicy" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceDelegatedAuthenticationPolicy",
      "allowedProviders" : [ "java.util.ArrayList", [ "Facebook", "Twitter" ] ],
      "permitUndefined": true,
      "exclusive": true
    }
  }
}
</code></pre>
<p>Note that:</p>
<ul>
<li>The list of allowed providers should contain the external identity provider names (i.e. client names).</li>
<li>The <code>permitUndefined</code> flag decides whether access should be granted in the event that no allowed providers are defined explicitly.</li>
<li>The <code>exclusive</code> flag decides whether authentication should be exclusively limited to allowed providers, disabling other methods such as username/password, etc.</li>
</ul>
<h2>
<a id="provisioning" class="anchor" href="#provisioning" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Provisioning</h2>
<p>By default, user profiles that are extracted from external identity providers and merged into a CAS<br>
authenticated principal are not stored or tracked anywhere. CAS does provide additional options to allow<br>
such profiles to be managed outside of CAS and/or provisioned into identity stores, allowing you optionally to link<br>
external/guest accounts with their equivalent found in the authentication source used by CAS, etc.</p>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#pac4j-delegated-authn">review this guide</a>.</p>
<h3>
<a id="groovy-provisioner" class="anchor" href="#groovy-provisioner" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Groovy Provisioner</h3>
<p>Provisioning tasks can be carried out using an external Groovy script with the following structure:</p>
<pre lang="groovy"><code>def run(Object[] args) {
    def principal = args[0]
    def userProfile = args[1]
    def client = args[2]
    def logger = args[3]
    ...
}
</code></pre>
<p>It is not expected for the script to return a value. The following parameters are passed to the script:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>principal</code></td>
<td>CAS authenticated <code>Principal</code> that contains all attributes and claims.</td>
</tr>
<tr>
<td><code>userProfile</code></td>
<td>The original <code>UserProfile</code> extracted from the external identity provider.</td>
</tr>
<tr>
<td><code>client</code></td>
<td>The <code>Client</code> configuration responsible for the exchange between CAS and the identity provider.</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>The object responsible for issuing log messages such as <code>logger.info(...)</code>.</td>
</tr>
</tbody>
</table>
<h3>
<a id="rest-provisioner" class="anchor" href="#rest-provisioner" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST Provisioner</h3>
<p>Provisioning tasks can be carried out using an external REST endpoint expected to receive the following:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>principalId</code></td>
<td>CAS authenticated principal identifier.</td>
</tr>
<tr>
<td><code>principalAttributes</code></td>
<td>CAS authenticated principal attributes.</td>
</tr>
<tr>
<td><code>profileId</code></td>
<td>The identifier of the user profile extracted from the identity provider.</td>
</tr>
<tr>
<td><code>profileTypedId</code></td>
<td>The <em>typed</em> identifier of the user profile extracted from the identity provider.</td>
</tr>
<tr>
<td><code>profileAttributes</code></td>
<td>Collection of attributes extracted from the identity provider's response.</td>
</tr>
<tr>
<td><code>clientName</code></td>
<td>The client name responsible for the exchange between CAS and the identity provider.</td>
</tr>
</tbody>
</table>
<h2>
<a id="saml2-identity-providers" class="anchor" href="#saml2-identity-providers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML2 Identity Providers</h2>
<p>To learn more about delegating authentication to SAML2 identity providers,<br>
please <a href="Delegate-Authentication-SAML.html">review this guide</a>.</p>
<h2>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h2>
<p>To enable additional logging, configure the log4j configuration file to add the following<br>
levels:</p>
<pre lang="xml"><code>...
&lt;Logger name="org.pac4j" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/Logger&gt;
...
</code></pre>