<hr>
<h2>
<a id="layout-defaulttitle-cas---cas-ws-federation-protocolcategory-protocols" class="anchor" href="#layout-defaulttitle-cas---cas-ws-federation-protocolcategory-protocols" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout: default<br>
title: CAS - CAS WS Federation Protocol<br>
category: Protocols</h2>
<p>{% include variables.html %}</p>
<h1>
<a id="ws-federation-protocol" class="anchor" href="#ws-federation-protocol" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>WS Federation Protocol</h1>
<p>CAS can act as a standalone identity provider, presenting support for the <a href="http://docs.oasis-open.org/wsfed/federation/v1.2/os/ws-federation-1.2-spec-os.html#_Toc223175002">WS-Federation Passive Requestor Profile</a>. The core functionality<br>
is built on top of <a href="http://cxf.apache.org/fediz.html">Apache Fediz</a> whose architecture is described <a href="http://cxf.apache.org/fediz-architecture.html">here</a>.</p>
<h2>
<a id="security-token-service" class="anchor" href="#security-token-service" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security Token Service</h2>
<p>The WS-Trust OASIS standard specifies a runtime component called Security Token Service. A service consumer requests a security token from the STS which is sent to the service provider. Either the service provider can validate the security token on its own or sends a request to the STS for validation. This pattern is based on an indirect trust relationship between the service provider and the STS instead of a direct trust between the service provider and service consumer. As long as the service consumer is in the possession of a security token issued by a trusted STS, the service provider accepts this security token.</p>
<p>A key benefit of the STS is the reduced complexity for applications. A web service consumer does not have to know how to create the various types of security<br>
tokens its service providers require. Instead, it sends a request to the STS containing the requirements of the client and the service provider and attaches the returned security token to the outgoing SOAP message to the service provider.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-ws-sts" %}</p>
<!-- raw HTML omitted -->
<h3>
<a id="endpoints" class="anchor" href="#endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Endpoints</h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/ws/sts</code></td>
<td>Presents the list of available SOAP services and their WSDL configuration for each REALM defined in the configuration.</td>
</tr>
</tbody>
</table>
<h3>
<a id="security-tokens" class="anchor" href="#security-tokens" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security Tokens</h3>
<p>Security tokens issued are treated as CAS tickets, stored in the ticket registry under<br>
the prefix <code>STS</code> and follow the same semantics as all other ticket types when it comes to persistence,<br>
replication, etc. These tokens are closely tied to the lifetime of the ticket-granting tickets and match<br>
their expiration policy. Tokens themselves do not have a lifespan outside a valid ticket-granting ticket<br>
and support for ticket lifetime configuration is not present.</p>
<h2>
<a id="ws-federation-identity-provider" class="anchor" href="#ws-federation-identity-provider" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>WS Federation Identity Provider</h2>
<p>The security model of the STS builds on the foundation established by WS-Security and WS-Trust.<br>
The primary issue for Web browsers is that there is no easy way to directly send web service (SOAP) requests.<br>
Consequently, the processing must be performed within the confines of the base HTTP 1.1 functionality (<code>GET</code>, <code>POST</code>, redirects, and cookies)<br>
and conform as closely as possible to the WS-Trust protocols for token acquisition.<br>
The IdP is in charge of transforming the sign-in request of the browser to a SOAP request for the STS and the response of the<br>
STS to the sign-in response for the browser. Further the browser user must authenticate with the IdP.</p>
<p>Support is enabled by including the following dependency in the WAR overlay:</p>
<p>{% include casmodule.html group="org.apereo.cas" module="cas-server-support-ws-idp" %}</p>
<h3>
<a id="endpoints-1" class="anchor" href="#endpoints-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Endpoints</h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/ws/idp/metadata</code></td>
<td>Displays the current federation metadata based on the configuration realm for the identity provider.</td>
</tr>
<tr>
<td><code>/ws/idp/federation</code></td>
<td>Endpoint to receive initial <code>GET</code> authentication requests from clients, typically identified as the <code>issuer</code>.</td>
</tr>
</tbody>
</table>
<h2>
<a id="realms" class="anchor" href="#realms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Realms</h2>
<p>At this point, by default security token service's endpoint operate using a single realm configuration and identity provider<br>
configuration is only able to recognize and request tokens for a single realm.<br>
While support for multiple realms is not there yet, in general the underlying configuration<br>
should allow for that feature to exist in later releases. The default realm recognized by<br>
CAS is set to be <code>urn:org:apereo:cas:ws:idp:realm-CAS</code>. Registration of clients need to ensure this value is matched.</p>
<h2>
<a id="register-clients" class="anchor" href="#register-clients" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Register Clients</h2>
<p>Clients and relying parties can be registered with CAS as such:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.ws.idp.services.WSFederationRegisteredService",
  "serviceId" : "https://wsfed.example.org/.+",
  "name" : "Sample WsFed Application",
  "id" : 100
}
</code></pre>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>serviceId</code></td>
<td>Callback/Consumer url where tokens may be <code>POST</code>ed, typically matching the <code>wreply</code> parameter.</td>
</tr>
<tr>
<td><code>realm</code></td>
<td>The realm identifier of the application, identified via the <code>wtrealm</code> parameter. This needs to match the realm defined for the identity provider. By default it's set to the realm defined for the CAS identity provider.</td>
</tr>
<tr>
<td><code>appliesTo</code></td>
<td>Controls to whom security tokens apply. Defaults to the <code>realm</code>.</td>
</tr>
</tbody>
</table>
<p>Service definitions may be managed by the <a href="../services/Service-Management.html">service management</a> facility.</p>
<h3>
<a id="standard-claims" class="anchor" href="#standard-claims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Standard Claims</h3>
<p>Attribute filtering and release policies are defined per relying party. See <a href="../integration/Attribute-Release-Policies.html">this guide</a> for more info.</p>
<p>The following standard claims are supported by CAS for release:</p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EMAIL_ADDRESS_2005</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress</code></td>
</tr>
<tr>
<td><code>EMAIL_ADDRESS</code></td>
<td><code>http://schemas.xmlsoap.org/claims/EmailAddress</code></td>
</tr>
<tr>
<td><code>GIVEN_NAME</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname</code></td>
</tr>
<tr>
<td><code>NAME</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name</code></td>
</tr>
<tr>
<td><code>USER_PRINCIPAL_NAME_2005</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn</code></td>
</tr>
<tr>
<td><code>USER_PRINCIPAL_NAME</code></td>
<td><code>http://schemas.xmlsoap.org/claims/UPN</code></td>
</tr>
<tr>
<td><code>COMMON_NAME</code></td>
<td><code>http://schemas.xmlsoap.org/claims/CommonName</code></td>
</tr>
<tr>
<td><code>GROUP</code></td>
<td><code>http://schemas.xmlsoap.org/claims/Group</code></td>
</tr>
<tr>
<td><code>MS_ROLE</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/role</code></td>
</tr>
<tr>
<td><code>ROLE</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role</code></td>
</tr>
<tr>
<td><code>SURNAME</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname</code></td>
</tr>
<tr>
<td><code>PRIVATE_ID</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/privatepersonalidentifier</code></td>
</tr>
<tr>
<td><code>NAME_IDENTIFIER</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier</code></td>
</tr>
<tr>
<td><code>AUTHENTICATION_METHOD</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod</code></td>
</tr>
<tr>
<td><code>DENY_ONLY_GROUP_SID</code></td>
<td><code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/denyonlysid</code></td>
</tr>
<tr>
<td><code>DENY_ONLY_PRIMARY_SID</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/denyonlyprimarysid</code></td>
</tr>
<tr>
<td><code>DENY_ONLY_PRIMARY_GROUP_SID</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/denyonlyprimarygroupsid</code></td>
</tr>
<tr>
<td><code>GROUP_SID</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid</code></td>
</tr>
<tr>
<td><code>PRIMARY_GROUP_SID</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/primarygroupsid</code></td>
</tr>
<tr>
<td><code>PRIMARY_SID</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid</code></td>
</tr>
<tr>
<td><code>WINDOWS_ACCOUNT_NAME</code></td>
<td><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname</code></td>
</tr>
<tr>
<td><code>PUID</code></td>
<td><code>http://schemas.xmlsoap.org/claims/PUID</code></td>
</tr>
</tbody>
</table>
<p>The attribute release policy assigned to relying parties and services is able to link a given standard claim and map it to an attribute<br>
that should be already available. The configuration looks as such:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.ws.idp.services.WSFederationRegisteredService",
  "serviceId" : "https://wsfed.example.org/.+",
  "realm" : "urn:wsfed:example:org:sampleapplication",
  "name" : "WSFED",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.ws.idp.services.WSFederationClaimsReleasePolicy",
    "allowedAttributes" : {
      "@class" : "java.util.TreeMap",
      "GIVEN_NAME" : "givenName"
    }
  }
}
</code></pre>
<p>The above snippet allows CAS to release the claim <code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname</code> whose value<br>
is identified by the value of the <code>givenName</code> attribute that is already retrieved for the authenticated principal.</p>
<h3>
<a id="inline-groovy-claims" class="anchor" href="#inline-groovy-claims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Inline Groovy Claims</h3>
<p>Claims may produce their values from an inline Groovy script. As an example, the claim <code>EMAIL_ADDRESS_2005</code> may be constructed<br>
as a dynamic attribute whose value is determined by the inline Groovy script attribute and the <code>cn</code> attribute:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 300,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.ws.idp.services.WSFederationClaimsReleasePolicy",
    "allowedAttributes" : {
      "@class" : "java.util.TreeMap",
      "EMAIL_ADDRESS_2005" : "groovy { return attributes['cn'].get(0) + '@example.org' }"
    }
  }
}
</code></pre>
<h3>
<a id="file-based-groovy-claims" class="anchor" href="#file-based-groovy-claims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>File-based Groovy Claims</h3>
<p>Claims may produce their values from an external Groovy script. As an example, the claim <code>EMAIL_ADDRESS_2005</code> may be constructed<br>
as a dynamic attribute whose value is determined by the Groovy script attribute and the <code>cn</code> attribute:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "sample",
  "name" : "sample",
  "id" : 300,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.ws.idp.services.WSFederationClaimsReleasePolicy",
    "allowedAttributes" : {
      "@class" : "java.util.TreeMap",
      "EMAIL_ADDRESS_2005" : "file:/path/to/script.groovy"
    }
  }
}
</code></pre>
<p>The configuration of this component qualifies to use the <a href="../configuration/Configuration-Spring-Expressions.html">Spring Expression Language</a> syntax. The script<br>
itself may have the following outline:</p>
<pre lang="groovy"><code>def run(final Object... args) {
    def attributes = args[0]
    def logger = args[1]

    logger.info "Attributes currently resolved: ${attributes}"
    return [attributes["cn"][0] + "@example.org"]
}
</code></pre>
<h3>
<a id="custom-claims" class="anchor" href="#custom-claims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom Claims</h3>
<p>You may also decide to release non-standard claims as part of a custom namespace. For example, the below snippet allows CAS to release the claim <code>https://github.com/apereo/cas/employeeNumber</code> whose value is identified by the value of the <code>personSecurityId</code> attribute that is already retrieved for the authenticated principal.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.ws.idp.services.WSFederationRegisteredService",
  "serviceId" : "https://wsfed.example.org/.+",
  "realm" : "urn:wsfed:example:org:sampleapplication",
  "name" : "WSFED",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.ws.idp.services.CustomNamespaceWSFederationClaimsReleasePolicy",
    "namespace": "https://github.com/apereo/cas",
    "allowedAttributes" : {
      "@class" : "java.util.TreeMap",
      "employeeNumber" : "personSecurityId"
    }
  }
}
</code></pre>
<h2>
<a id="token-types" class="anchor" href="#token-types" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Token Types</h2>
<p>The following token types are supported by CAS:</p>
<table>
<thead>
<tr>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</code></td>
</tr>
<tr>
<td><code>http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0</code></td>
</tr>
<tr>
<td><code>urn:ietf:params:oauth:token-type:jwt</code></td>
</tr>
<tr>
<td><code>http://docs.oasis-open.org/ws-sx/ws-secureconversation/200512/sct</code></td>
</tr>
</tbody>
</table>
<p>Token type may be configured on a per-service basis:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.ws.idp.services.WSFederationRegisteredService",
  "serviceId" : "https://wsfed.example.org/.+",
  "realm" : "urn:wsfed:example:org:sampleapplication",
  "name" : "WSFED",
  "id" : 1,
  "tokenType": "http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1"
}
</code></pre>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>To see the relevant list of CAS properties, please <a href="../configuration/Configuration-Properties.html#ws-federation">review this guide</a>.</p>
<p>You may also need to declare the following repository in<br>
your CAS Overlay to be able to resolve dependencies:</p>
<pre lang="groovy"><code>repositories {
    maven { 
        mavenContent { releasesOnly() }
        url "https://build.shibboleth.net/nexus/content/repositories/releases" 
    }
}
</code></pre>
<h2>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h2>
<p>To enable additional logging, modify the logging configuration file to add the following:</p>
<pre lang="xml"><code>&lt;Logger name="org.apache.cxf" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/Logger&gt;
</code></pre>